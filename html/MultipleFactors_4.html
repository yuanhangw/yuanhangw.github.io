---
layout: page
title: Multiple Factors - QUAL - Quality is underated
tag: post
date: 2016-01-29 15:41:18
categories: matlab
---

<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Multiple Factors - QUAL</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-01-29"><meta name="DC.source" content="MultipleFactors_4.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Multiple Factors - QUAL</h1><!--introduction--><p>I have done this before...</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Load Data</a></li><li><a href="#5">Weight*Return</a></li><li><a href="#9">Sequential test</a></li><li><a href="#20">Remarks on QUAL</a></li><li><a href="#23">Large Dataset</a></li><li><a href="#41">Percentile analysis.</a></li><li><a href="#51">What are those anormalies in the top 100 in 8900??</a></li></ul></div><h2>Load Data<a name="1"></a></h2><p>Let's load the data from ..</p><pre class="codeinput">load(<span class="string">'../data_equity_list_us.mat'</span>);
load(<span class="string">'../data_field_list.mat'</span>);
load(<span class="string">'../data_historical_data_us.mat'</span>);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index = datasample(1:1300,1000,<span class="string">'Replace'</span>,false);
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px);
list = equity_list_us(index,:);
</pre><p>load observations</p><pre class="codeinput">grossmargin_ts  = fun_load_observations(history_us, equity_list_us, index,<span class="string">'gm'</span>);
turnover_ts     = fun_load_observations(history_us, equity_list_us, index,<span class="string">'turnover'</span>);
roa_ts          = fun_load_observations(history_us, equity_list_us, index,<span class="string">'roa'</span>);
leverage_ts     = fun_load_observations(history_us, equity_list_us, index,<span class="string">'leverage'</span>);
</pre><p>generate the scores.</p><pre class="codeinput">score_leverage_ts = -fun_calculate_score(leverage_ts,list,<span class="string">'sectorsort'</span>,px);
score_roa_ts = fun_calculate_score(roa_ts,list,<span class="string">'sectorsort'</span>,px);
score_grossmargin_ts = fun_calculate_score(grossmargin_ts,list,<span class="string">'sectorsort'</span>,px);
score_turnover_ts = fun_calculate_score(turnover_ts,list,<span class="string">'sectorsort'</span>,px);

score_quality_ts = score_leverage_ts+score_roa_ts+score_grossmargin_ts+score_turnover_ts;

plot(fts2mat(score_quality_ts));
snapnow;

score_quality_ts = fun_combine_score(score_quality_ts);

plot(fts2mat(score_quality_ts));
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_01.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_02.png" alt=""> <h2>Weight*Return<a name="5"></a></h2><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);


plot(cumsum(portfolio_longonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts(50:end)),0)]
snapnow;
</pre><pre class="codeoutput">
ans =

    0.7568    0.6160

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_03.png" alt=""> <p>quite significant sharpe improvement..</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longshort'</span>);
portfolio_longshort_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'topm'</span>,0.1);
portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

plot(cumsum(portfolio_longshort_rt_ts));
legend(<span class="string">'off'</span>);

plot(cumsum(portfolio_topm_rt_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">off</span>;
snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts(50:end)),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_04.png" alt=""> <pre class="codeoutput">
ans =

    0.1989    0.1801

</pre><p>I like those sharpe numbers!</p><pre class="codeinput">corrcoef(fts2mat(portfolio_longshort_rt_ts(50:end)), fts2mat(portfolio_equalweight_rt_ts(50:end)))
corrcoef(fts2mat(portfolio_topm_rt_ts(50:end)), fts2mat(portfolio_equalweight_rt_ts(50:end)))
</pre><pre class="codeoutput">
ans =

    1.0000   -0.5199
   -0.5199    1.0000


ans =

    1.0000   -0.0298
   -0.0298    1.0000

</pre><p>negative correlation with long short! I like those correlation numbers!</p><h2>Sequential test<a name="9"></a></h2><p>give me my benchmark</p><pre class="codeinput">portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'equalweight'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts);
benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts = fints(px.dates, benchmark,<span class="string">'EqualWeightIndex'</span>);

plot(log(benchmark_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_05.png" alt=""> <p>let's rock</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'topmlongonly'</span>,1);
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'topmlongonly'</span>,0.3);
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))

hold <span class="string">off</span>;
snapnow;
</pre><pre class="codeoutput">
ans =

    0.6806


ans =

    1.0000   -0.2550
   -0.2550    1.0000


ans =

    0.5369


ans =

    1.0000   -0.2928
   -0.2928    1.0000


ans =

    0.4807


ans =

    1.0000   -0.3047
   -0.3047    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_06.png" alt=""> <p>correlation is negative oh....</p><p>let's check on partial hedge.</p><p>something to compare to..</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">on</span>;
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))
</pre><pre class="codeoutput">
ans =

    0.5369


ans =

    1.0000   -0.2928
   -0.2928    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_07.png" alt=""> <p>going partial.</p><p>capital neutral.</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_partial(100, px, benchmark_ts,1, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">on</span>;
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))
</pre><pre class="codeoutput">
ans =

    0.4240


ans =

    1.0000   -0.4079
   -0.4079    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_08.png" alt=""> <p>target for 0 correlation</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_partial(100, px, benchmark_ts,0.9, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">on</span>;
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))
</pre><pre class="codeoutput">
ans =

    0.8496


ans =

    1.0000    0.0692
    0.0692    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_09.png" alt=""> <p>top 0.3 target for 0 correlation (score nolonger distributed evenly between[-1 1] after combination.</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'topmlongonly'</span>,0.3);
portfolio_cap_ts = fun_sequential_backtest_partial(100, px, benchmark_ts,0.9, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">on</span>;
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))
</pre><pre class="codeoutput">
ans =

    0.8605


ans =

    1.0000    0.1366
    0.1366    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_10.png" alt=""> <p>correlation down to 0.</p><pre class="codeinput">plot(log(benchmark_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_11.png" alt=""> <h2>Remarks on QUAL<a name="20"></a></h2><p>similar to BAB, risk adjusted factor portoflio doesn't really make it uncorrelated to the market. this means some part of its risk is not from market but some other sources. pure quality has good drift.</p><p>AQR result seems to be constructed from capital neutral.</p><h2>Large Dataset<a name="23"></a></h2><p>load the big dataset</p><pre class="codeinput">load(<span class="string">'../Big Data/data_equity_list.mat'</span>);
load(<span class="string">'../Big Data/data_historical_data_jan16.mat'</span>);

equity_list = equity_list(1:size(storage0,1),:);

equity_list_us_large = equity_list(strcmp(equity_list(:,2),<span class="string">'US'</span>),:);
history_us_large = storage0(strcmp(equity_list(:,2),<span class="string">'US'</span>),:);

clear <span class="string">storage0</span>;
clear <span class="string">equity_list</span>;

equity_list_us_large = equity_list_us_large(not(cellfun(@isempty,history_us_large(:,1))),:);
history_us_large = history_us_large(not(cellfun(@isempty,history_us_large(:,1))),:);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index_large = datasample(1:8900,8001,<span class="string">'Replace'</span>,false);
px_large = fun_load_price_large(history_us_large, equity_list_us_large, index_large);
px_large = fun_clean_data(px_large);
list_large = equity_list_us_large(index_large,:);
</pre><p>load observations</p><pre class="codeinput">grossmargin_ts  = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,<span class="string">'gm'</span>);
turnover_ts     = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,<span class="string">'turnover'</span>);
roa_ts          = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,<span class="string">'roa'</span>);
leverage_ts     = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,<span class="string">'leverage'</span>);
</pre><p>generate the scores.</p><pre class="codeinput">score_leverage_ts = -fun_calculate_score(leverage_ts,list_large,<span class="string">'sectorsort'</span>,px_large);
score_roa_ts = fun_calculate_score(roa_ts,list_large,<span class="string">'sectorsort'</span>,px_large);
score_grossmargin_ts = fun_calculate_score(grossmargin_ts,list_large,<span class="string">'sectorsort'</span>,px_large);
score_turnover_ts = fun_calculate_score(turnover_ts,list_large,<span class="string">'sectorsort'</span>,px_large);

score_quality_ts_large = score_leverage_ts+score_roa_ts+score_grossmargin_ts+score_turnover_ts;

plot(fts2mat(score_quality_ts_large));
snapnow;

score_quality_ts_large = fun_combine_score(score_quality_ts_large);

plot(fts2mat(score_quality_ts_large));
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_12.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_13.png" alt=""> <p>give me my benchmark</p><pre class="codeinput">portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'equalweight'</span>);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_eq_weight_ts);
benchmark_large = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts_large = fints(px_large.dates, benchmark_large,<span class="string">'EqualWeightIndex'</span>);
</pre><p>compare the two benchmark</p><pre class="codeinput">plot(log(benchmark_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(log(benchmark_ts_large));
legend(<span class="string">'off'</span>);
snapnow;
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_14.png" alt=""> <p>compare longonly</p><p>auto first.</p><p>1300 auto</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(120:end), benchmark_ts(120:end),portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">on</span>;
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(120:end))))
</pre><pre class="codeoutput">
ans =

    0.7164


ans =

    1.0000   -0.2808
   -0.2808    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_15.png" alt=""> <p>8900 auto</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px_large(120:end), benchmark_ts_large(120:end),portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))))
</pre><pre class="codeoutput">
ans =

    1.1620


ans =

    1.0000   -0.2493
   -0.2493    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_16.png" alt=""> <p>add some reference.</p><pre class="codeinput">plot(log(benchmark_ts_large));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_17.png" alt=""> <pre>the correlation is still negative though. let's take a look
at partial</pre><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_partial(100, px(70:end), benchmark_ts(70:end),0.91,portfolio_weight_ts(70:end),false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

hold <span class="string">on</span>;
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts),0))
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(70:end))))
</pre><pre class="codeoutput">Warning: No Cash return specified. Will assume return is 0. 

ans =

    0.8127


ans =

    1.0000    0.0177
    0.0177    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_18.png" alt=""> <p>8900 partial</p><p>full capital hedged</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),1,portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))))
</pre><pre class="codeoutput">
ans =

    0.7651


ans =

    1.0000   -0.4923
   -0.4923    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_19.png" alt=""> <p>0.9 hedge ratio</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'longonly'</span>);
portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9,portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0)
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))))
</pre><pre class="codeoutput">
ans =

    1.2863


ans =

    1.0000    0.0879
    0.0879    1.0000

</pre><img vspace="5" hspace="5" src="MultipleFactors_4_20.png" alt=""> <p>add some reference.</p><pre class="codeinput">plot(log(benchmark_ts_large));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_21.png" alt=""> <p>Fully hedged version is very very close to AQR published result, maybe they made a mistake. or they just intend to ?</p><h2>Percentile analysis.<a name="41"></a></h2><p>top N for 8900</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'topmlongonly'</span>,0.1*i);
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile);
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_22.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_23.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_24.png" alt=""> <p>zoom in top ~1000</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'topmlongonly'</span>,0.01*i);
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile);
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_25.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_26.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_27.png" alt=""> <p>break down into percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'topmnlongonly'</span>,0.01*i,0.01*(i-1));
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile);
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_28.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_29.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_30.png" alt=""> <p>it looks like we have some anormalies in the top 100. let's take out those. and run the full percentile again.</p><p>8900 without the top 100</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'topmnlongonly'</span>,0.1*i,0.01);
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.91, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile);
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_31.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_32.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_33.png" alt=""> <p>8900 each percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,<span class="string">'topmnlongonly'</span>,0.1*i,0.1*(i-1));
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.91, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile);
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_34.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_35.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_36.png" alt=""> <p>PROPER..</p><p>top N for 1300</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'topmlongonly'</span>,0.1*i);
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px(70:end), benchmark_ts(70:end),0.91, portfolio_weight_ts(70:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(70:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile)
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_37.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_38.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_39.png" alt=""> <p>1300 each percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,<span class="string">'topmnlongonly'</span>,0.1*i,0.1*(i-1));
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px(70:end), benchmark_ts(70:end),0.91, portfolio_weight_ts(70:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(70:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile)
snapnow;

plot(correlation);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_4_40.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_41.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_4_42.png" alt=""> <h2>What are those anormalies in the top 100 in 8900??<a name="51"></a></h2><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Multiple Factors - QUAL 
% I have done this before... 


 

%% Load Data
% Let's load the data from ..

load('../data_equity_list_us.mat'); 
load('../data_field_list.mat'); 
load('../data_historical_data_us.mat'); 



%%
% take data sample, load data & the list
index = datasample(1:1300,1000,'Replace',false); 
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px); 
list = equity_list_us(index,:); 


%%
% load observations

grossmargin_ts  = fun_load_observations(history_us, equity_list_us, index,'gm');
turnover_ts     = fun_load_observations(history_us, equity_list_us, index,'turnover');
roa_ts          = fun_load_observations(history_us, equity_list_us, index,'roa');
leverage_ts     = fun_load_observations(history_us, equity_list_us, index,'leverage');

%%
% generate the scores. 

score_leverage_ts = -fun_calculate_score(leverage_ts,list,'sectorsort',px);
score_roa_ts = fun_calculate_score(roa_ts,list,'sectorsort',px);
score_grossmargin_ts = fun_calculate_score(grossmargin_ts,list,'sectorsort',px);
score_turnover_ts = fun_calculate_score(turnover_ts,list,'sectorsort',px);

score_quality_ts = score_leverage_ts+score_roa_ts+score_grossmargin_ts+score_turnover_ts;

plot(fts2mat(score_quality_ts));
snapnow;

score_quality_ts = fun_combine_score(score_quality_ts);

plot(fts2mat(score_quality_ts));
snapnow;

%% Weight*Return
% 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 


plot(cumsum(portfolio_longonly_rt_ts)); 
legend('off');
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off');

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts(50:end)),0)]
snapnow; 

%%
% quite significant sharpe improvement..

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longshort'); 
portfolio_longshort_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'topm',0.1); 
portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

plot(cumsum(portfolio_longshort_rt_ts)); 
legend('off');

plot(cumsum(portfolio_topm_rt_ts)); 
legend('off');

hold off; 
snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts(50:end)),0)]

%%
% I like those sharpe numbers!

corrcoef(fts2mat(portfolio_longshort_rt_ts(50:end)), fts2mat(portfolio_equalweight_rt_ts(50:end)))
corrcoef(fts2mat(portfolio_topm_rt_ts(50:end)), fts2mat(portfolio_equalweight_rt_ts(50:end)))


%%
% negative correlation with long short! I like those correlation numbers!

%% Sequential test

%%
% give me my benchmark


portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'equalweight'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts); 
benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts = fints(px.dates, benchmark,'EqualWeightIndex'); 

plot(log(benchmark_ts));
legend('off'); 
hold on; 
%%
% let's rock 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'topmlongonly',1); 
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'topmlongonly',0.3); 
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))

hold off; 
snapnow; 

%%
% correlation is negative oh....

%%
% let's check on partial hedge. 

%%
% something to compare to.. 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px, benchmark_ts, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');

hold on; 
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))


%%
% going partial. 

%%
% capital neutral. 
portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_partial(100, px, benchmark_ts,1, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');

hold on; 
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))


%%
% target for 0 correlation
portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_partial(100, px, benchmark_ts,0.9, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');

hold on; 
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))

%%
% top 0.3 target for 0 correlation (score nolonger distributed evenly
% between[-1 1] after combination. 
portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'topmlongonly',0.3); 
portfolio_cap_ts = fun_sequential_backtest_partial(100, px, benchmark_ts,0.9, portfolio_weight_ts,false);

plot(log(portfolio_cap_ts)); 
legend('off');

hold on; 
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts(70:end))),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts(70:end))), fts2mat(tick2ret(benchmark_ts(70:end))))



%%
% correlation down to 0. 

plot(log(benchmark_ts)); 
legend('off');
hold off

%% Remarks on QUAL
%
%%
% similar to BAB, risk adjusted factor portoflio doesn't really make it
% uncorrelated to the market. this means some part of its risk is not from
% market but some other sources. pure quality has good drift. 

%%
% AQR result seems to be constructed from capital neutral. 

%% Large Dataset
%

%%
% load the big dataset 
load('../Big Data/data_equity_list.mat'); 
load('../Big Data/data_historical_data_jan16.mat'); 

equity_list = equity_list(1:size(storage0,1),:); 

equity_list_us_large = equity_list(strcmp(equity_list(:,2),'US'),:); 
history_us_large = storage0(strcmp(equity_list(:,2),'US'),:); 

clear storage0; 
clear equity_list; 

equity_list_us_large = equity_list_us_large(not(cellfun(@isempty,history_us_large(:,1))),:); 
history_us_large = history_us_large(not(cellfun(@isempty,history_us_large(:,1))),:); 


%%
% take data sample, load data & the list
index_large = datasample(1:8900,8001,'Replace',false); 
px_large = fun_load_price_large(history_us_large, equity_list_us_large, index_large);
px_large = fun_clean_data(px_large); 
list_large = equity_list_us_large(index_large,:); 


%%
% load observations

grossmargin_ts  = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,'gm');
turnover_ts     = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,'turnover');
roa_ts          = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,'roa');
leverage_ts     = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,'leverage');

%%
% generate the scores. 

score_leverage_ts = -fun_calculate_score(leverage_ts,list_large,'sectorsort',px_large);
score_roa_ts = fun_calculate_score(roa_ts,list_large,'sectorsort',px_large);
score_grossmargin_ts = fun_calculate_score(grossmargin_ts,list_large,'sectorsort',px_large);
score_turnover_ts = fun_calculate_score(turnover_ts,list_large,'sectorsort',px_large);

score_quality_ts_large = score_leverage_ts+score_roa_ts+score_grossmargin_ts+score_turnover_ts;

plot(fts2mat(score_quality_ts_large));
snapnow;

score_quality_ts_large = fun_combine_score(score_quality_ts_large);

plot(fts2mat(score_quality_ts_large));
snapnow;

%%
% give me my benchmark

portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'equalweight'); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_eq_weight_ts); 
benchmark_large = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts_large = fints(px_large.dates, benchmark_large,'EqualWeightIndex'); 

%%
% compare the two benchmark

plot(log(benchmark_ts)); 
legend('off'); 
hold on; 

plot(log(benchmark_ts_large)); 
legend('off'); 
snapnow; 
hold off; 

%%
% compare longonly 

%%
% auto first. 

%%
% 1300 auto
portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(120:end), benchmark_ts(120:end),portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts)); 
legend('off');

hold on; 
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(120:end))))

%%
% 8900 auto

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px_large(120:end), benchmark_ts_large(120:end),portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts)); 
legend('off');

sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))))

%%
% add some reference. 

plot(log(benchmark_ts_large)); 
legend('off'); 
hold off; 

snapnow; 

%%
%  the correlation is still negative though. let's take a look
% at partial 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_partial(100, px(70:end), benchmark_ts(70:end),0.91,portfolio_weight_ts(70:end),false);

plot(log(portfolio_cap_ts)); 
legend('off');

hold on; 
sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts),0)) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(70:end))))

%%
% 8900 partial

%%
% full capital hedged

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),1,portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts)); 
legend('off');

sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))))

%%
% 0.9 hedge ratio

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'longonly'); 
portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9,portfolio_weight_ts(120:end),false);

plot(log(portfolio_cap_ts)); 
legend('off');

sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) 
corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end))))

%%
% add some reference. 

plot(log(benchmark_ts_large)); 
legend('off'); 
hold off; 

snapnow; 

%%
% Fully hedged version is very very close to AQR published result, maybe
% they made a mistake. or they just intend to ?


%% Percentile analysis. 
% 

%%
% top N for 8900

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'topmlongonly',0.1*i); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile);
snapnow; 

plot(correlation);
snapnow; 

%% 
% zoom in top ~1000

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'topmlongonly',0.01*i); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile);
snapnow; 

plot(correlation);
snapnow; 


%%
% break down into percentile 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'topmnlongonly',0.01*i,0.01*(i-1)); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.9, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile);
snapnow; 

plot(correlation);
snapnow; 
%%
% it looks like we have some anormalies in the top 100. let's take out
% those. and run the full percentile again. 

%%
% 8900 without the top 100
i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'topmnlongonly',0.1*i,0.01); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.91, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile);
snapnow; 

plot(correlation);
snapnow; 


%%
% 8900 each percentile 
i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts_large,'topmnlongonly',0.1*i,0.1*(i-1)); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px_large(120:end), benchmark_ts_large(120:end),0.91, portfolio_weight_ts(120:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(120:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile);
snapnow; 

plot(correlation);
snapnow; 

%%
% PROPER..

%%
% top N for 1300

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'topmlongonly',0.1*i); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px(70:end), benchmark_ts(70:end),0.91, portfolio_weight_ts(70:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(70:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile)
snapnow; 

plot(correlation);
snapnow; 

%%
% 1300 each percentile 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_quality_ts,'topmnlongonly',0.1*i,0.1*(i-1)); 
  portfolio_cap_ts = fun_sequential_backtest_partial(100, px(70:end), benchmark_ts(70:end),0.91, portfolio_weight_ts(70:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(70:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile)
snapnow; 

plot(correlation);
snapnow; 


%% What are those anormalies in the top 100 in 8900??
%
##### SOURCE END #####
--></body></html>