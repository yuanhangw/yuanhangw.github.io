---
layout: page
title: MOM 2->N Noise->Signal
tag: post
date: 2016-01-24 01:12:18
categories: matlab
---

<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Mom proper.</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-01-24"><meta name="DC.source" content="SimpleMomentumFactor_3.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Mom proper.</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">ToDos</a></li><li><a href="#4">MOM for 2.</a></li><li><a href="#7">Data Integrity</a></li><li><a href="#17">2-&gt;N</a></li><li><a href="#19">Long only</a></li><li><a href="#20">Short equal weight index</a></li></ul></div><h2>ToDos<a name="1"></a></h2><div><ul><li>put a few repeated scripts into functions, i.e. generator portfolio weight so that the published html looks more concise.  (x)</li><li>understand MOM with two random securities, and note down the exception.(x)</li><li>study MOM as we increase the securities. understand the relationship between N, drift, and noise. (x)</li><li>study two weighting schemes: equal weight, weighting according to score, and the effect of reducing N. (x)</li><li>study ideal MOM with respect to equal weight short MOM &amp; cap weight short MOM.(cap weight next post)</li><li>study MOM with limited amount of long securities and cap weight benchmark short. This is most practical case. (next post)</li><li>walk forward MOM, address the practical issues (next post)</li></ul></div><p>As usual, my plan get out of control again!</p><h2>MOM for 2.<a name="4"></a></h2><pre class="codeinput">load(<span class="string">'data_equity_list_us.mat'</span>);
load(<span class="string">'data_field_list.mat'</span>);
load(<span class="string">'data_historical_data_us.mat'</span>);

i = 1;

<span class="keyword">while</span> i &lt;= 4

<span class="comment">% randomly pick data from the list.</span>
index = datasample(1:1300,2,<span class="string">'Replace'</span>,false);

<span class="comment">% load price, calculate mom, calculate portfolio weight and calculate</span>
<span class="comment">% portfolio return are now in functions.</span>
px = fun_load_price(history_us, equity_list_us, index);
mom_ts = fun_calculate_mom(px);
portfolio_weight_ts = fun_portfolio_weight(mom_ts,<span class="string">'longshort'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);


<span class="comment">% let's check out the result.</span>
fun_show_result(px,mom_ts,portfolio_weight_ts,portfolio_rt_ts);
snapnow;

i = i+1;

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_01.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_02.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_03.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_04.png" alt=""> <p>with only two securites, my momentum portfolio can run into ridiculous situation. For example, if one security drop to 0.1, I will be shorting a humongous amount of that security to be 'neutral'. But neutral with respect to what? The portfolio is capital neutral. In terms of risk, securities trading at very low price could have very little 'risk', if I define risk as permanent loss of capital.</p><p>I can check long only portfolio performance as well..</p><pre class="codeinput">i = 1;

<span class="keyword">while</span> i &lt;= 4

<span class="comment">% randomly pick data from the list.</span>
index = datasample(1:1300,2,<span class="string">'Replace'</span>,false);

<span class="comment">% load price, calculate mom, calculate portfolio weight and calculate</span>
<span class="comment">% portfolio return are now in functions.</span>
px = fun_load_price(history_us, equity_list_us, index);
mom_ts = fun_calculate_mom(px);
portfolio_weight_ts = fun_portfolio_weight(mom_ts,<span class="string">'longonly'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);


<span class="comment">% let's check out the result.</span>
fun_show_result(px,mom_ts,portfolio_weight_ts,portfolio_rt_ts);
snapnow;

i = i+1;

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_05.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_06.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_07.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_08.png" alt=""> <h2>Data Integrity<a name="7"></a></h2><p>Before move from 2 to N, let's check data integrity again.</p><pre class="codeinput">index = datasample(1:1300,1300,<span class="string">'Replace'</span>,false);
px = fun_load_price(history_us, equity_list_us, index);
px_mat = fts2mat(px);

rt_geo = tick2ret(px,<span class="string">'Method'</span>,<span class="string">'Continuous'</span>);
rt_simple = tick2ret(px,<span class="string">'Method'</span>,<span class="string">'Simple'</span>);

rt_mat_geo = fts2mat(rt_geo);
rt_mat_simple = fts2mat(rt_simple);

figure
plot(rt_mat_geo);
snapnow;
plot(rt_mat_simple);
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_09.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_10.png" alt=""> <p>let's check out those extreme arithmetic returns.</p><pre class="codeinput">i  = find((max(rt_mat_simple)&gt;4));

plot(log(px_mat(:,i)));
snapnow;


i = find((min(rt_mat_geo)&lt;-3));

plot(log((px_mat(:,i))));
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_11.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_12.png" alt=""> <p>by add geometric return togather I get a picture of market volatility.</p><pre class="codeinput">vol_ts = fints(rt_simple.dates, sqrt(12)*nanmean(abs(rt_mat_geo'))',<span class="string">'MarketVolatility'</span>);

plot(vol_ts);
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_13.png" alt=""> <p>some price data bounces between two prices incessantly, let's see if we can identify them.</p><pre class="codeinput">plot(abs(rt_mat_geo))
snapnow;

plot(cumsum(abs(rt_mat_geo)))
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_14.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_15.png" alt=""> <p>no I cannot. doesn't matter, let's keep moving.</p><p>let's write a function to clearup the data from its source.</p><pre class="codeinput">px_clean = fun_clean_data(px);
px_clean_mat = fts2mat(px_clean);
</pre><p>let's check the result.</p><pre class="codeinput">i = find((max(abs(rt_mat_geo))&gt;3));

semilogy((px_mat(:,i)));
ylim([0.0001 1000]);
snapnow;


semilogy((px_clean_mat(:,i)));
ylim([0.0001 1000]);
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_16.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_17.png" alt=""> <p>let's check the result with equal weight portfolio</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight(px,<span class="string">'equalweight'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);
portfolio_rt_clean_ts = fun_portfolio_return(px_clean, portfolio_weight_ts);

figure
plot(cumsum(portfolio_rt_ts));
hold <span class="string">on</span>;
plot(cumsum(portfolio_rt_clean_ts));
legend(<span class="string">'off'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_18.png" alt=""> <p>this result is comparable with s&amp;p.</p><pre class="codeinput">load(<span class="string">'data_benchmark.mat'</span>,<span class="string">'storage'</span>)

spx = fints(storage{1}{1}(:,1),storage{1}{1}(:,2),<span class="string">'SPX'</span>,<span class="string">'d'</span>,<span class="string">'S&amp;P Monthly Data'</span>);
spx = tomonthly(spx);

spx_rt = tick2ret(spx);

plot(cumsum(spx_rt));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_19.png" alt=""> <h2>2-&gt;N<a name="17"></a></h2><p>So MOM for 2 securities is trivial. What is going to happen as we increase N? let's exam.</p><pre class="codeinput">i =1;
<span class="keyword">while</span> i&lt;= 10

  index = datasample(1:1300,2^i,<span class="string">'Replace'</span>,false);
  px = fun_load_price(history_us, equity_list_us, index);
  px = fun_clean_data(px);
  mom_ts = fun_calculate_mom(px);
  portfolio_weight_ts = fun_portfolio_weight(mom_ts,<span class="string">'longshort'</span>);
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  plot(cumsum(portfolio_rt_ts));
  legend(<span class="string">'off'</span>);
  hold <span class="string">on</span>
  snapnow;

  i=i+1;


<span class="keyword">end</span>

hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_20.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_21.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_22.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_23.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_24.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_25.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_26.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_27.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_28.png" alt=""> <img vspace="5" hspace="5" src="SimpleMomentumFactor_3_29.png" alt=""> <p>one common feature is around 2008, all of them experienced a big drawdown.</p><h2>Long only<a name="19"></a></h2><p>Let's take a look at long only.</p><pre class="codeinput">i =1;
<span class="keyword">while</span> i&lt;= 10

  index = datasample(1:1300,2^i,<span class="string">'Replace'</span>,false);
  px = fun_load_price(history_us, equity_list_us, index);
  px = fun_clean_data(px);
  mom_ts = fun_calculate_mom(px);
  portfolio_weight_ts = fun_portfolio_weight(mom_ts,<span class="string">'longonly'</span>);
  portfolio_weight_eq_ts = fun_portfolio_weight(px,<span class="string">'equalweight'</span>);
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);
  portfolio_rt_eq_ts = fun_portfolio_return(px, portfolio_weight_eq_ts);
  plot(cumsum(portfolio_rt_ts));
  legend(<span class="string">'off'</span>);
  hold <span class="string">on</span>;
  plot(cumsum(portfolio_rt_eq_ts));
  legend(<span class="string">'off'</span>);
  hold <span class="string">off</span>;

  snapnow;

  disp(sprintf(<span class="string">'with %d securities'</span> ,2^i));
  sharpe_eq(i) = sqrt(12)*sharpe(fts2mat(portfolio_rt_eq_ts),0);
  sharpe_mom(i) = sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0);
  [sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_rt_eq_ts),0)]

  i=i+1;


<span class="keyword">end</span>


plot(sharpe_eq);
hold <span class="string">on</span>;
plot(sharpe_mom);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_30.png" alt=""> <pre class="codeoutput">with 2 securities

ans =

    0.2216    0.6511

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_31.png" alt=""> <pre class="codeoutput">with 4 securities

ans =

    0.2350    0.5916

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_32.png" alt=""> <pre class="codeoutput">with 8 securities

ans =

    0.2791    0.1012

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_33.png" alt=""> <pre class="codeoutput">with 16 securities

ans =

    0.5795    0.5908

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_34.png" alt=""> <pre class="codeoutput">with 32 securities

ans =

    0.6200    0.5919

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_35.png" alt=""> <pre class="codeoutput">with 64 securities

ans =

    0.6137    0.5429

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_36.png" alt=""> <pre class="codeoutput">with 128 securities

ans =

    0.6351    0.5571

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_37.png" alt=""> <pre class="codeoutput">with 256 securities

ans =

    0.7917    0.6369

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_38.png" alt=""> <pre class="codeoutput">with 512 securities

ans =

    0.7483    0.6014

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_39.png" alt=""> <pre class="codeoutput">with 1024 securities

ans =

    0.7801    0.6104

</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_40.png" alt=""> <h2>Short equal weight index<a name="20"></a></h2><p>our naive longshort strategy is.. naive. let's see what happens if we change our short side to equal weight index instead. which is more close to what we can do in reality.</p><pre class="codeinput">i =1;
<span class="keyword">while</span> i&lt;= 10

  index = datasample(1:1300,2^i,<span class="string">'Replace'</span>,false);
  px = fun_load_price(history_us, equity_list_us, index);
  px = fun_clean_data(px);
  mom_ts = fun_calculate_mom(px);
  portfolio_weight_ts = fun_portfolio_weight(mom_ts,<span class="string">'longshorteq'</span>);
  portfolio_weight_eq_ts = fun_portfolio_weight(mom_ts,<span class="string">'equalweight'</span>);
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);
  portfolio_rt_eq_ts = fun_portfolio_return(px, portfolio_weight_eq_ts);


  plot(cumsum(portfolio_rt_ts));
  legend(<span class="string">'off'</span>);
  hold <span class="string">on</span>
  plot(cumsum(portfolio_rt_eq_ts));
  legend(<span class="string">'off'</span>);
  hold <span class="string">off</span>

  snapnow;


  disp(sprintf(<span class="string">'with %d securities'</span> ,2^i));
  sharpe_longshorteq(i) = sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0);

  i=i+1;
<span class="keyword">end</span>

hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_41.png" alt=""> <pre class="codeoutput">with 2 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_42.png" alt=""> <pre class="codeoutput">with 4 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_43.png" alt=""> <pre class="codeoutput">with 8 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_44.png" alt=""> <pre class="codeoutput">with 16 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_45.png" alt=""> <pre class="codeoutput">with 32 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_46.png" alt=""> <pre class="codeoutput">with 64 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_47.png" alt=""> <pre class="codeoutput">with 128 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_48.png" alt=""> <pre class="codeoutput">with 256 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_49.png" alt=""> <pre class="codeoutput">with 512 securities
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_50.png" alt=""> <pre class="codeoutput">with 1024 securities
</pre><p>we have some more sensible result here.</p><pre class="codeinput">plot(sharpe_longshorteq);
</pre><img vspace="5" hspace="5" src="SimpleMomentumFactor_3_51.png" alt=""> <p>compare sharpe ratio with/ without the momentum crash in 2008:</p><pre class="codeinput">[sqrt(12)*sharpe(fts2mat(portfolio_rt_ts(1:(end-100))),0) sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)]
</pre><pre class="codeoutput">
ans =

    0.5199    0.3027

</pre><p>correlation with market</p><pre class="codeinput">corrcoef(portfolio_rt_ts,portfolio_rt_eq_ts)
</pre><pre class="codeoutput">
ans =

    1.0000   -0.3449
   -0.3449    1.0000

</pre><p>correlation with market without momentum crash</p><pre class="codeinput">corrcoef(portfolio_rt_ts(1:(end-100)),portfolio_rt_eq_ts(1:(end-100)))
</pre><pre class="codeoutput">
ans =

    1.0000   -0.0984
   -0.0984    1.0000

</pre><p>Very little indeed.</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Mom proper. 
%%

%% ToDos 

%%
% * put a few repeated scripts into functions, i.e. generator portfolio weight
% so that the published html looks more concise.  (x)
% * understand MOM with two random securities, and note down the
% exception.(x)
% * study MOM as we increase the securities. understand the relationship
% between N, drift, and noise. (x)
% * study two weighting schemes: equal weight, weighting according to
% score, and the effect of reducing N. (x)
% * study ideal MOM with respect to equal weight short MOM & cap weight
% short MOM.(cap weight next post)
% * study MOM with limited amount of long securities and cap weight
% benchmark short. This is most practical case. (next post)
% * walk forward MOM, address the practical issues (next post)

%%
% As usual, my plan get out of control again!

%% MOM for 2. 

load('data_equity_list_us.mat'); 
load('data_field_list.mat'); 
load('data_historical_data_us.mat'); 

i = 1; 

while i <= 4

% randomly pick data from the list. 
index = datasample(1:1300,2,'Replace',false); 

% load price, calculate mom, calculate portfolio weight and calculate
% portfolio return are now in functions. 
px = fun_load_price(history_us, equity_list_us, index);
mom_ts = fun_calculate_mom(px); 
portfolio_weight_ts = fun_portfolio_weight(mom_ts,'longshort'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 


% let's check out the result. 
fun_show_result(px,mom_ts,portfolio_weight_ts,portfolio_rt_ts); 
snapnow; 

i = i+1; 

end 

%%
% with only two securites, my momentum portfolio can run into ridiculous
% situation. For example, if one security drop to 0.1, I will be shorting
% a humongous amount of that security to be 'neutral'. But neutral with
% respect to what? The portfolio is capital neutral. In terms of risk,
% securities trading at very low price could have very little 'risk', if I
% define risk as permanent loss of capital.

%%
% I can check long only portfolio performance as well.. 

i = 1; 

while i <= 4

% randomly pick data from the list. 
index = datasample(1:1300,2,'Replace',false); 

% load price, calculate mom, calculate portfolio weight and calculate
% portfolio return are now in functions. 
px = fun_load_price(history_us, equity_list_us, index);
mom_ts = fun_calculate_mom(px); 
portfolio_weight_ts = fun_portfolio_weight(mom_ts,'longonly'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 


% let's check out the result. 
fun_show_result(px,mom_ts,portfolio_weight_ts,portfolio_rt_ts); 
snapnow; 

i = i+1; 

end 


%% Data Integrity
%% 
% Before move from 2 to N, let's check data integrity again. 

index = datasample(1:1300,1300,'Replace',false); 
px = fun_load_price(history_us, equity_list_us, index);
px_mat = fts2mat(px); 

rt_geo = tick2ret(px,'Method','Continuous');
rt_simple = tick2ret(px,'Method','Simple');

rt_mat_geo = fts2mat(rt_geo); 
rt_mat_simple = fts2mat(rt_simple); 

figure 
plot(rt_mat_geo); 
snapnow;
plot(rt_mat_simple); 
snapnow;

%%
% let's check out those extreme arithmetic returns. 

i  = find((max(rt_mat_simple)>4));

plot(log(px_mat(:,i)));
snapnow;


i = find((min(rt_mat_geo)<-3));

plot(log((px_mat(:,i))));
snapnow;


%%
% by add geometric return togather I get a picture of market volatility. 

vol_ts = fints(rt_simple.dates, sqrt(12)*nanmean(abs(rt_mat_geo'))','MarketVolatility'); 

plot(vol_ts);
snapnow;

%%
% some price data bounces between two prices incessantly, let's see if we
% can identify them. 

plot(abs(rt_mat_geo))
snapnow;

plot(cumsum(abs(rt_mat_geo)))
snapnow;

%%
% no I cannot. doesn't matter, let's keep moving. 

%%
% let's write a function to clearup the data from its source. 

px_clean = fun_clean_data(px); 
px_clean_mat = fts2mat(px_clean); 
%%
% let's check the result. 

i = find((max(abs(rt_mat_geo))>3));

semilogy((px_mat(:,i)));
ylim([0.0001 1000]);
snapnow; 


semilogy((px_clean_mat(:,i)));
ylim([0.0001 1000]);
snapnow; 

%%
% let's check the result with equal weight portfolio

portfolio_weight_ts = fun_portfolio_weight(px,'equalweight'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 
portfolio_rt_clean_ts = fun_portfolio_return(px_clean, portfolio_weight_ts); 

figure
plot(cumsum(portfolio_rt_ts));
hold on; 
plot(cumsum(portfolio_rt_clean_ts));
legend('off'); 
snapnow; 

%%
% this result is comparable with s&p. 

load('data_benchmark.mat','storage')

spx = fints(storage{1}{1}(:,1),storage{1}{1}(:,2),'SPX','d','S&P Monthly Data');
spx = tomonthly(spx); 

spx_rt = tick2ret(spx); 

plot(cumsum(spx_rt));
legend('off');
hold off; 
snapnow; 

%% 2->N
% So MOM for 2 securities is trivial. What is going to happen as we
% increase N? let's exam. 


i =1; 
while i<= 10
  
  index = datasample(1:1300,2^i,'Replace',false); 
  px = fun_load_price(history_us, equity_list_us, index);
  px = fun_clean_data(px); 
  mom_ts = fun_calculate_mom(px); 
  portfolio_weight_ts = fun_portfolio_weight(mom_ts,'longshort'); 
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  plot(cumsum(portfolio_rt_ts));
  legend('off');
  hold on
  snapnow; 

  i=i+1; 
  

end

hold off; 

%%
% one common feature is around 2008, all of them experienced a big
% drawdown. 

%% Long only 
% Let's take a look at long only. 


i =1; 
while i<= 10
  
  index = datasample(1:1300,2^i,'Replace',false); 
  px = fun_load_price(history_us, equity_list_us, index);
  px = fun_clean_data(px); 
  mom_ts = fun_calculate_mom(px); 
  portfolio_weight_ts = fun_portfolio_weight(mom_ts,'longonly'); 
  portfolio_weight_eq_ts = fun_portfolio_weight(px,'equalweight'); 
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 
  portfolio_rt_eq_ts = fun_portfolio_return(px, portfolio_weight_eq_ts); 
  plot(cumsum(portfolio_rt_ts));
  legend('off');
  hold on; 
  plot(cumsum(portfolio_rt_eq_ts)); 
  legend('off');
  hold off; 
  
  snapnow; 

  disp(sprintf('with %d securities' ,2^i));
  sharpe_eq(i) = sqrt(12)*sharpe(fts2mat(portfolio_rt_eq_ts),0); 
  sharpe_mom(i) = sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0); 
  [sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_rt_eq_ts),0)]
  
  i=i+1; 
  

end


plot(sharpe_eq);
hold on;
plot(sharpe_mom);
hold off;


%% Short equal weight index
% our naive longshort strategy is.. naive. let's see what happens if we
% change our short side to equal weight index instead. which is more close
% to what we can do in reality. 



i =1; 
while i<= 10
  
  index = datasample(1:1300,2^i,'Replace',false); 
  px = fun_load_price(history_us, equity_list_us, index);
  px = fun_clean_data(px); 
  mom_ts = fun_calculate_mom(px); 
  portfolio_weight_ts = fun_portfolio_weight(mom_ts,'longshorteq'); 
  portfolio_weight_eq_ts = fun_portfolio_weight(mom_ts,'equalweight'); 
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 
  portfolio_rt_eq_ts = fun_portfolio_return(px, portfolio_weight_eq_ts);
  
  
  plot(cumsum(portfolio_rt_ts));
  legend('off');
  hold on
  plot(cumsum(portfolio_rt_eq_ts));
  legend('off');
  hold off
  
  snapnow; 

   
  disp(sprintf('with %d securities' ,2^i));
  sharpe_longshorteq(i) = sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0); 
  
  i=i+1;
end

hold off; 

%%
% we have some more sensible result here. 
plot(sharpe_longshorteq); 

%%
% compare sharpe ratio with/ without the momentum crash in 2008:

[sqrt(12)*sharpe(fts2mat(portfolio_rt_ts(1:(end-100))),0) sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)]

%%
% correlation with market

corrcoef(portfolio_rt_ts,portfolio_rt_eq_ts)

%%
% correlation with market without momentum crash

corrcoef(portfolio_rt_ts(1:(end-100)),portfolio_rt_eq_ts(1:(end-100)))

%%
% Very little indeed. 





##### SOURCE END #####
--></body></html>