---
layout: page
title: Multiple Factor - HML
tag: post
date: 2016-01-27 17:23:18
categories: matlab
---

<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Multiple Factors - HML</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-01-27"><meta name="DC.source" content="MultipleFactors_1.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Multiple Factors - HML</h1><!--introduction--><p>HML is one of the simplest factors. Let's take a look.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Load Data</a></li><li><a href="#9">Check signal.</a></li><li><a href="#22">Percentile analysis</a></li><li><a href="#26">Large dataset test</a></li><li><a href="#37">Conclusion</a></li></ul></div><h2>Load Data<a name="1"></a></h2><p>Let's load the data from ..</p><pre class="codeinput">load(<span class="string">'../data_equity_list_us.mat'</span>);
load(<span class="string">'../data_field_list.mat'</span>);
load(<span class="string">'../data_historical_data_us.mat'</span>);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index = datasample(1:1300,1000,<span class="string">'Replace'</span>,false);
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px);
list = equity_list_us(index,:);
</pre><p>load the PB ratios</p><pre class="codeinput">pb_ts = fun_load_observations(history_us, equity_list_us, index,<span class="string">'pb'</span>);
</pre><p>I have looked at the medium PB previously</p><pre class="codeinput">plot(pb_ts.dates,nanmedian(fts2mat(pb_ts),2));
datetick(<span class="string">'x'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_01.png" alt=""> <p>pb data is not available for most equty until late 80s.</p><p>let's take a look at the full dataset.</p><pre class="codeinput">plot(pb_ts.dates,fts2mat(pb_ts));
datetick(<span class="string">'x'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_02.png" alt=""> <p>I can clean up the pb data for extreme value, but I prefer to leave it intact. Since we cleaned up price data, let's see what's the corresponding pb data looks like</p><pre class="codeinput">pb_mat = fts2mat(pb_ts);
px_mat = fts2mat(px);

pb_mat(isnan(px_mat))=nan;

plot(pb_ts.dates,pb_mat);
datetick(<span class="string">'x'</span>);
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_03.png" alt=""> <p>much better.</p><h2>Check signal.<a name="9"></a></h2><p>Does low valuation securites out perform on risk adjust basis? Let's compare portfolio constructed using only low pb stocks v.s. is equal weighted conterpart.</p><pre class="codeinput">score_pb_ts = -fun_calculate_score(pb_ts,list,<span class="string">'fullsort'</span>);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longonly'</span>);
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);
</pre><p>let's check the result.</p><pre class="codeinput">plot(cumsum(portfolio_longonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts(50:end)),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_04.png" alt=""> <pre class="codeoutput">
ans =

    0.5219    0.6198

</pre><p>doesn't seems to be very promising.</p><p>let's take a look at the sector sorted portfolio</p><pre class="codeinput">score_pb_ts = -fun_calculate_score(pb_ts,list,<span class="string">'sectorsort'</span>);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longonly'</span>);
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

<span class="comment">% let's check the result.</span>
plot(cumsum(portfolio_longonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_05.png" alt=""> <pre class="codeoutput">
ans =

    0.6261    0.6592

</pre><p>sector weight give me a more balance portfolio and improved the sharpe by 5 basis points. most of the outperformance came in after dotcom bubble.</p><p>HML is very different from MOM. even though the long only portfolio outperformed equal weighted portfolio, in terms of sharpe it is worse. The outperformance is gained by assuming more 'risk'.</p><p>There is a slightly tricky question here. what extra 'risk' is it? if it is market risk, then HML is useless. but if it is another type of risk different from market risk, then it might be useful from diversification point of view.</p><p>with this question in mind, let's check pure long short factor portfolio against equal weighted market portfolio.</p><pre class="codeinput">score_pb_ts = -fun_calculate_score(pb_ts,list,<span class="string">'sectorsort'</span>);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longshort'</span>);
portfolio_longshort_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

<span class="comment">% let's check the result.</span>
plot(cumsum(portfolio_longshort_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_06.png" alt=""> <pre class="codeoutput">
ans =

    0.3243    0.6592

</pre><p>if additional risk is mainly market risk, then long short portfolio should be highly correlated with equal weighted benchmark. let's check out the correlation:</p><pre class="codeinput">corrcoef(fts2mat(portfolio_longshort_rt_ts(1:end)), fts2mat(portfolio_equalweight_rt_ts(1:end)))
</pre><pre class="codeoutput">
ans =

    1.0000    0.6169
    0.6169    1.0000

</pre><p>the correlation is quite high... this is not what I expected, but let's accept the facts.</p><p>let's see how the top percentile securities do</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topm'</span>,0.2);
portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmlongonly'</span>,0.2);
portfolio_topmlongonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

<span class="comment">% let's check the result.</span>
plot(cumsum(portfolio_topm_rt_ts));
legend(<span class="string">'off'</span>);

plot(cumsum(portfolio_topmlongonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0)]
[sqrt(12)*sharpe(fts2mat(portfolio_topmlongonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_07.png" alt=""> <pre class="codeoutput">
ans =

    0.3826    0.3243


ans =

    0.5873    0.6592

</pre><p>the drawdown is huge for top 20%, 63%(!) in 2008. 10% more than equal weighted index...</p><pre class="codeinput">maxdrawdown(exp(fts2mat(cumsum(portfolio_topmlongonly_rt_ts))))
maxdrawdown(exp(fts2mat(cumsum(portfolio_equalweight_rt_ts))))
</pre><pre class="codeoutput">
ans =

    0.6490


ans =

    0.5438

</pre><p>I can check my historical portfolio pb and compare that to the market median.</p><pre class="codeinput">score_mat = fts2mat(score_pb_ts);
pb_mat = fts2mat(pb_ts);
pb_selected = pb_mat;
pb_selected(score_mat&lt;0.2)=nan;

plot(pb_ts.dates,nanmedian(pb_mat,2));
hold <span class="string">on</span>;
plot(pb_ts.dates,nanmedian(pb_selected,2));
hold <span class="string">off</span>;
datetick(<span class="string">'x'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_08.png" alt=""> <h2>Percentile analysis<a name="22"></a></h2><p>let's take a look at the relationship with N</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topm'</span>,0.1*i);
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_09.png" alt=""> <p>let's take a look at each percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmn'</span>,0.1*i,0.1*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_10.png" alt=""> <p>zoom in</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmn'</span>,0.01*i,0.01*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_11.png" alt=""> <p>signal strength</p><pre class="codeinput">plot(sharpe_top);
hold <span class="string">on</span>;
plot(sharpe_top_percentile);
plot(sharpe_top_percentile_zoom);
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_12.png" alt=""> <h2>Large dataset test<a name="26"></a></h2><p>load the big dataset</p><pre class="codeinput">load(<span class="string">'../Big Data/data_equity_list.mat'</span>);
load(<span class="string">'../Big Data/data_historical_data_jan16.mat'</span>);

equity_list = equity_list(1:size(storage0,1),:);

equity_list_us_large = equity_list(strcmp(equity_list(:,2),<span class="string">'US'</span>),:);
history_us_large = storage0(strcmp(equity_list(:,2),<span class="string">'US'</span>),:);

clear <span class="string">storage0</span>;
clear <span class="string">equity_list</span>;

equity_list_us_large = equity_list_us_large(not(cellfun(@isempty,history_us_large(:,1))),:);
history_us_large = history_us_large(not(cellfun(@isempty,history_us_large(:,1))),:);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index_large = datasample(1:8900,8001,<span class="string">'Replace'</span>,false);
px_large = fun_load_price_large(history_us_large, equity_list_us_large, index_large);
px_large = fun_clean_data(px_large);
list_large = equity_list_us_large(index_large,:);
</pre><p>load the PB ratios</p><pre class="codeinput">pb_ts_large = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,<span class="string">'pb'</span>);
</pre><p>calculate score</p><pre class="codeinput">score_pb_ts_large = -fun_calculate_score(pb_ts_large,list_large,<span class="string">'sectorsort'</span>);
</pre><p>compare the result:</p><p>pure long short</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'longshort'</span>);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)
hold <span class="string">on</span>;

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longshort'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)

hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_13.png" alt=""> <p>pure top 10%</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topm'</span>,0.1);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)
hold <span class="string">on</span>;

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmn'</span>,0.1,0.02);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topm'</span>,0.1);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)

hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_14.png" alt=""> <p>each percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmn'</span>,0.1*i,0.1*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile_large(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_top_percentile_large);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_15.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_16.png" alt=""> <p>zoom into first 800</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmn'</span>,0.01*i,0.01*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile_large_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_top_percentile_large_zoom);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_17.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_18.png" alt=""> <p>similar to MOM, larger dataset doesn't really improve the factor performance in any obvious way. Besides, when I use 8900 securites, the very top 200 security has negative signals.</p><h2>Conclusion<a name="37"></a></h2><div><ol><li>HML is highly correlated with market, but it is not all about correlations</li><li>Sector sort works!</li><li>HML is a 'pain now for reward later' factor.</li><li>Larger dataset doesn't really improve performance, and beaware of the top 1% if you use large dataset.</li></ol></div><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Multiple Factors - HML
% HML is one of the simplest factors. Let's take a look. 

%% Load Data
% Let's load the data from ..

load('../data_equity_list_us.mat'); 
load('../data_field_list.mat'); 
load('../data_historical_data_us.mat'); 


%%
% take data sample, load data & the list
index = datasample(1:1300,1000,'Replace',false); 
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px); 
list = equity_list_us(index,:); 

%%
% load the PB ratios

pb_ts = fun_load_observations(history_us, equity_list_us, index,'pb'); 


%%
% I have looked at the medium PB previously 

plot(pb_ts.dates,nanmedian(fts2mat(pb_ts),2));
datetick('x'); 
snapnow; 

%%
% pb data is not available for most equty until late 80s. 

%%
% let's take a look at the full dataset. 
 
plot(pb_ts.dates,fts2mat(pb_ts));
datetick('x'); 
snapnow; 

%%
% I can clean up the pb data for extreme value, but I prefer to leave it
% intact. Since we cleaned up price data, let's see what's the
% corresponding pb data looks like

pb_mat = fts2mat(pb_ts); 
px_mat = fts2mat(px);

pb_mat(isnan(px_mat))=nan; 

plot(pb_ts.dates,pb_mat); 
datetick('x'); 

%%
% much better. 

%% Check signal. 
% Does low valuation securites out perform on risk adjust basis? Let's
% compare portfolio constructed using only low pb stocks v.s. is equal
% weighted conterpart. 

score_pb_ts = -fun_calculate_score(pb_ts,list,'fullsort'); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longonly'); 
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

%%
% let's check the result. 

plot(cumsum(portfolio_longonly_rt_ts)); 
legend('off'); 
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off'); 
hold off; 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts(50:end)),0)]

%%
% doesn't seems to be very promising. 

%%
% let's take a look at the sector sorted portfolio

score_pb_ts = -fun_calculate_score(pb_ts,list,'sectorsort'); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longonly'); 
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

% let's check the result. 
plot(cumsum(portfolio_longonly_rt_ts)); 
legend('off'); 
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off'); 
hold off; 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]

%%
% sector weight give me a more balance portfolio and improved the sharpe by
% 5 basis points. most of the outperformance came in after dotcom bubble. 

%%
% HML is very different from MOM. even though the long only portfolio
% outperformed equal weighted portfolio, in terms of sharpe it is worse.
% The outperformance is gained by assuming more 'risk'. 

%%
% There is a slightly tricky question here. what extra 'risk' is it? if it
% is market risk, then HML is useless. but if it is another type of risk
% different from market risk, then it might be useful from diversification
% point of view. 

%%
% with this question in mind, let's check pure long short factor portfolio against equal
% weighted market portfolio. 


score_pb_ts = -fun_calculate_score(pb_ts,list,'sectorsort'); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longshort'); 
portfolio_longshort_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

% let's check the result. 
plot(cumsum(portfolio_longshort_rt_ts)); 
legend('off'); 
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off'); 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]

%%
% if additional risk is mainly market risk, then long short portfolio
% should be highly correlated with equal weighted benchmark. let's check
% out the correlation:

corrcoef(fts2mat(portfolio_longshort_rt_ts(1:end)), fts2mat(portfolio_equalweight_rt_ts(1:end)))

%%
% the correlation is quite high... this is not what I expected, but let's
% accept the facts. 


%%
% let's see how the top percentile securities do


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topm',0.2); 
portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmlongonly',0.2); 
portfolio_topmlongonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

% let's check the result. 
plot(cumsum(portfolio_topm_rt_ts)); 
legend('off'); 

plot(cumsum(portfolio_topmlongonly_rt_ts)); 
legend('off'); 
hold off; 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0)]
[sqrt(12)*sharpe(fts2mat(portfolio_topmlongonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]

%%
% the drawdown is huge for top 20%, 63%(!) in 2008. 10% more than equal
% weighted index...

maxdrawdown(exp(fts2mat(cumsum(portfolio_topmlongonly_rt_ts))))
maxdrawdown(exp(fts2mat(cumsum(portfolio_equalweight_rt_ts))))

%%
% I can check my historical portfolio pb and compare that to the market
% median. 

score_mat = fts2mat(score_pb_ts);
pb_mat = fts2mat(pb_ts); 
pb_selected = pb_mat;
pb_selected(score_mat<0.2)=nan; 

plot(pb_ts.dates,nanmedian(pb_mat,2)); 
hold on; 
plot(pb_ts.dates,nanmedian(pb_selected,2)); 
hold off; 
datetick('x'); 
snapnow; 

%% Percentile analysis 
% let's take a look at the relationship with N

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topm',0.1*i); 
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

%%
% let's take a look at each percentile 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmn',0.1*i,0.1*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

%%
% zoom in
i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmn',0.01*i,0.01*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

%%
% signal strength

plot(sharpe_top);
hold on; 
plot(sharpe_top_percentile);
plot(sharpe_top_percentile_zoom); 



%% Large dataset test

%%
% load the big dataset 
load('../Big Data/data_equity_list.mat'); 
load('../Big Data/data_historical_data_jan16.mat'); 

equity_list = equity_list(1:size(storage0,1),:); 

equity_list_us_large = equity_list(strcmp(equity_list(:,2),'US'),:); 
history_us_large = storage0(strcmp(equity_list(:,2),'US'),:); 

clear storage0; 
clear equity_list; 

equity_list_us_large = equity_list_us_large(not(cellfun(@isempty,history_us_large(:,1))),:); 
history_us_large = history_us_large(not(cellfun(@isempty,history_us_large(:,1))),:); 


%%
% take data sample, load data & the list
index_large = datasample(1:8900,8001,'Replace',false); 
px_large = fun_load_price_large(history_us_large, equity_list_us_large, index_large);
px_large = fun_clean_data(px_large); 
list_large = equity_list_us_large(index_large,:); 



%%
% load the PB ratios

pb_ts_large = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,'pb'); 

%%
% calculate score

score_pb_ts_large = -fun_calculate_score(pb_ts_large,list_large,'sectorsort'); 

%%
% compare the result:
%%
% pure long short

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'longshort'); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')
hold on; 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longshort'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')

hold off; 

%%
% pure top 10%


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topm',0.1); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')
hold on; 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmn',0.1,0.02); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topm',0.1); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')

hold off; 

%%
% each percentile 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmn',0.1*i,0.1*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile_large(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_top_percentile_large); 
snapnow; 

%%
% zoom into first 800

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmn',0.01*i,0.01*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile_large_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_top_percentile_large_zoom); 
snapnow; 

%%
% similar to MOM, larger dataset doesn't really improve the factor
% performance in any obvious way. Besides, when I use 8900 securites, the
% very top 200 security has negative signals. 


%% Conclusion

%%
% # HML is highly correlated with market, but it is not all about
% correlations
% # Sector sort works! 
% # HML is a 'pain now for reward later' factor. 
% # Larger dataset doesn't really improve performance, and beaware of the top 1% if you use large dataset. 
##### SOURCE END #####
--></body></html>