<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Combined Factors - Theory mixed with a little bit of reality</title>
    <meta name="description" content="keep it simple :: finish it off :: iterate
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://yuanhangw.github.com/html/CombinedFactors_1.html">
</head>


  
  <body>

    <header class="site-header">

  <div class="wrapper">
  


    
    <a class="site-title" href="/"> 
    <img class ="logo" src="/Mobius.jpg" alt="" height="50" width="50">nion</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      
      <!--
      <div class="trigger">
        
          
          <a class="page-link" href="/html/CombinedFactor_10.html">Combined Factors - Second Descend (neutral)</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_11.html">Combined Factors - Minor choices (with leverage)</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_12.html">Combined Factors - Minor choices (without leverage)</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_13.html">Combined Factors Summary</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_14.html">Combined Factors - Citius, Altius, Fortius</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_15.html">Combined Factors - low volatility index</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_16.html">Combined Factors - Individual Factor for large dataset</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_7.html">Combined Factors - Constant dripping wears away a stone.</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_8.html">Combined Factors - Portfolio Animation</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactor_9.html">Combined Factors - First Descend (Long only)</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_1.html">Combined Factors - Theory mixed with a little bit of reality</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_2.html">Combined Factors - Policy Portfolios</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_3.html">Combined Factors - Policy Portfolios with large dataset</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_4.html">Combined Factors - The Dark Force is Strong</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_5.html">Combined Factors - Fillts() or not Fillts(), That is the questoin</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_6.html">Combined Factors - Detail! Detail! Detail!</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_toolbox.html">Combined Factors - In theory ...</a>
          
        
          
          <a class="page-link" href="/html/ExpectedMaximumDrawDown.html">Drawdown</a>
          
        
          
          <a class="page-link" href="/html/FREDData.html">Retrieve data from FRED database</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors.html">Multiple Factors - Load Data</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_1.html">Multiple Factors - HML updated with Risk adjustment</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_2.html">Multiple Factors - SML adjust for risk</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_3.html">Multiple Factors - BAB watch out for correlation</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_4.html">Multiple Factors - QUAL - Quality is underated</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_5.html">Multiple Factors - Revisit MOM</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_6.html">Multiple Factors - Sanity Check</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_7.html">Multiple Factors - All in one</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_8.html">Multiple Factors - Bigger All in one</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor.html">Introducing Mother of all Factors - MOM</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_1.html">MOM factor walkforward</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_2.html">MOM too good to be true?</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_3.html">MOM 2->N</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_4.html">MOM short Cap weighted index?</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_5.html">MOM walkforward with N securities</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_6.html">MOM sector neutral</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_7.html">MOM alternative MOM</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_8.html">MOM the bigger the better?</a>
          
        
          
          <a class="page-link" href="/html/WhatInMyDataSet.html">What's in my dataset</a>
          
        
          
          <a class="page-link" href="/html/WhatInMyEquityList.html">Equity List and Field List</a>
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/post.html">Post</a>
          
        
      </div>
      -->
      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/post.html">Post</a>
          
        
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Combined Factors - Theory mixed with a little bit of reality</h1>
  </header>

  <article class="post-content">
    <!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Combined Factors  -  In theory 2</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-02-01"><meta name="DC.source" content="CombinedFactors_1.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Combined Factors  -  In theory 2</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Preparation</a></li><li><a href="#6">Generate factor portfolio</a></li><li><a href="#8">Combined Factor portfolios</a></li><li><a href="#17">Combined factor portfolio with Market</a></li><li><a href="#25">Topm combined factor portfolio</a></li></ul></div><h2>Preparation<a name="1"></a></h2><p>Let's load the data from ..</p><pre class="codeinput">load(<span class="string">'../data_equity_list_us.mat'</span>);
load(<span class="string">'../data_field_list.mat'</span>);
load(<span class="string">'../data_historical_data_us.mat'</span>);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index = datasample(1:1300,1000,<span class="string">'Replace'</span>,false);
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px);
list = equity_list_us(index,:);
</pre><p>load observations</p><pre class="codeinput">mom_ts          = fun_calculate_mom(px);

pb_ts           = fun_load_observations(history_us, equity_list_us, index,<span class="string">'pb'</span>);
cap_ts          = fun_load_observations(history_us, equity_list_us, index,<span class="string">'cap'</span>);
beta_ts         = fun_load_observations(history_us, equity_list_us, index,<span class="string">'beta'</span>);

grossmargin_ts  = fun_load_observations(history_us, equity_list_us, index,<span class="string">'gm'</span>);
turnover_ts     = fun_load_observations(history_us, equity_list_us, index,<span class="string">'turnover'</span>);
roa_ts          = fun_load_observations(history_us, equity_list_us, index,<span class="string">'roa'</span>);
leverage_ts     = fun_load_observations(history_us, equity_list_us, index,<span class="string">'leverage'</span>);
</pre><p>calculate score</p><pre class="codeinput">score_mom_ts          =   fun_calculate_score(mom_ts,list,<span class="string">'sectorsort'</span>,px);

score_pb_ts           =   -fun_calculate_score(pb_ts,list,<span class="string">'sectorsort'</span>,px);
score_cap_ts          =   -fun_calculate_score(cap_ts,list,<span class="string">'sectorsort'</span>,px);
score_beta_ts         =   -fun_calculate_score(beta_ts,list,<span class="string">'sectorsort'</span>,px);


score_leverage_ts     =   -fun_calculate_score(leverage_ts,list,<span class="string">'sectorsort'</span>,px);
score_roa_ts          =   fun_calculate_score(roa_ts,list,<span class="string">'sectorsort'</span>,px);
score_grossmargin_ts  =   fun_calculate_score(grossmargin_ts,list,<span class="string">'sectorsort'</span>,px);
score_turnover_ts     =   fun_calculate_score(turnover_ts,list,<span class="string">'sectorsort'</span>,px);

score_quality_ts      =   score_leverage_ts+score_roa_ts+score_grossmargin_ts+score_turnover_ts;
score_quality_ts      =   fun_combine_score(score_quality_ts);
</pre><p>Trim</p><pre class="codeinput">score_mom_ts      = score_mom_ts(75:end);
score_pb_ts       = score_pb_ts(75:end);
score_cap_ts      = score_cap_ts(75:end);
score_beta_ts     = score_beta_ts(75:end);
score_quality_ts  = score_quality_ts(75:end);

score_ts = {score_mom_ts; score_pb_ts; score_cap_ts; score_beta_ts; score_quality_ts};

px = px(75:end);
</pre><h2>Generate factor portfolio<a name="6"></a></h2><p>Market neutral factor portfolios</p><pre class="codeinput">hedge_ratio = [0.82 1.25 1.25 0.73 0.88];

i = 1;
<span class="keyword">while</span> i&lt;=5


  <span class="comment">% load benchmark</span>

  portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},<span class="string">'equalweight'</span>);
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts);
  benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
  benchmark_ts{i} = fints(px.dates, benchmark,<span class="string">'EqualWeightIndex'</span>);


  <span class="comment">% calculate factor portfolio</span>
  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},<span class="string">'longonly'</span>);
  portfolio_cap_ts{i} = fun_sequential_backtest_partial(100, px, benchmark_ts{i}, hedge_ratio(i), portfolio_weight_ts,false);

  correlation_matrix = corrcoef(fts2mat(tick2ret(portfolio_cap_ts{i})), fts2mat(tick2ret(benchmark_ts{i})));
  correlation(i) = correlation_matrix(1,2);
  sharpe_ratio(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts{i})),0);
  vol(i) = sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts{i})));

  i = i+1;

<span class="keyword">end</span>

12*mean([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
corrcoef([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
12*cov([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])


plot(correlation);
snapnow;
plot(sharpe_ratio);
snapnow;
plot(vol);
snapnow;
</pre><pre class="codeoutput">
ans =

    0.0458   -0.0040    0.0352    0.0121    0.0293


ans =

    1.0000   -0.6788   -0.3751    0.2643    0.3778
   -0.6788    1.0000    0.6057   -0.3530   -0.5478
   -0.3751    0.6057    1.0000   -0.3196   -0.2935
    0.2643   -0.3530   -0.3196    1.0000    0.1224
    0.3778   -0.5478   -0.2935    0.1224    1.0000


ans =

    0.0039   -0.0022   -0.0011    0.0006    0.0008
   -0.0022    0.0028    0.0016   -0.0006   -0.0010
   -0.0011    0.0016    0.0024   -0.0005   -0.0005
    0.0006   -0.0006   -0.0005    0.0011    0.0001
    0.0008   -0.0010   -0.0005    0.0001    0.0012

</pre><img vspace="5" hspace="5" src="CombinedFactors_1_01.png" alt=""> <img vspace="5" hspace="5" src="CombinedFactors_1_02.png" alt=""> <img vspace="5" hspace="5" src="CombinedFactors_1_03.png" alt=""> <h2>Combined Factor portfolios<a name="8"></a></h2><p>put factor portfolio in order.</p><pre class="codeinput">FactorList = {<span class="string">'MOM'</span>, <span class="string">'HML'</span>, <span class="string">'SML'</span>, <span class="string">'BAB'</span>,<span class="string">'QUAL'</span>};

d = portfolio_cap_ts{1}.dates;
Xfts = fints(d, zeros(numel(d),5), FactorList);

Xfts.MOM  = fts2mat(portfolio_cap_ts{1});
Xfts.HML  = fts2mat(portfolio_cap_ts{2});
Xfts.SML  = fts2mat(portfolio_cap_ts{3});
Xfts.BAB  = fts2mat(portfolio_cap_ts{4});
Xfts.QUAL = fts2mat(portfolio_cap_ts{5});


plot(log(Xfts));
legend(<span class="string">'location'</span>,<span class="string">'northwest'</span>);
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_04.png" alt=""> <p>cash and market</p><pre class="codeinput">market_return = mean(fts2mat(tick2ret(benchmark_ts{1})));
market_vol = std(fts2mat(tick2ret(benchmark_ts{1})));

cash_return = 0.0008;
cash_vol = 0.0016;
</pre><p>estimate asset mean and covariance</p><pre class="codeinput">p = Portfolio(<span class="string">'AssetList'</span>, FactorList, <span class="string">'RiskFreeRate'</span>, cash_return);

p = estimateAssetMoments(p, Xfts, <span class="string">'dataformat'</span>, <span class="string">'prices'</span>);


p = setInitPort(p, 1/p.NumAssets);

[equal_weight_vol, equal_weight_return] = estimatePortMoments(p, p.InitPort);
</pre><p>plot</p><pre class="codeinput">figure;
clf;
portfolioexamples_plot(<span class="string">'Asset Risks and Returns'</span>, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, market_vol, market_return, {<span class="string">'Market'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, cash_vol, cash_return, {<span class="string">'Cash'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, equal_weight_vol, equal_weight_return, {<span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_05.png" alt=""> <p>optimze the portfolio</p><pre class="codeinput">p = setDefaultConstraints(p);

pwgt = estimateFrontier(p, 40);
[prsk, pret] = estimatePortMoments(p, pwgt);


clf;
portfolioexamples_plot(<span class="string">'Efficient Frontier'</span>, <span class="keyword">...</span>
	{<span class="string">'line'</span>, prsk, pret}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {<span class="string">'Market'</span>, <span class="string">'Cash'</span>, <span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_06.png" alt=""> <p>maximize sharpe ratio</p><pre class="codeinput">q = setBudget(p, 0, 1);

qwgt = estimateFrontier(q, 20);
[qrsk, qret] = estimatePortMoments(q, qwgt);

<span class="comment">% Plot efficient frontier with tangent line (0 to 1 cash)</span>

clf;
portfolioexamples_plot(<span class="string">'Efficient Frontier with Tangent Line'</span>, <span class="keyword">...</span>
	{<span class="string">'line'</span>, prsk, pret}, <span class="keyword">...</span>
	{<span class="string">'line'</span>, qrsk, qret, [], [], 1}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {<span class="string">'Market'</span>, <span class="string">'Cash'</span>, <span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});



p = setInitPort(p, 0);
swgt = estimateMaxSharpeRatio(p);
[srsk, sret] = estimatePortMoments(p, swgt);

disp(swgt);
disp(sqrt(12)*sret/srsk);
</pre><pre class="codeoutput">    0.2143
         0
    0.3922
    0.0784
    0.3151

    1.5717

</pre><img vspace="5" hspace="5" src="CombinedFactors_1_07.png" alt=""> <p>plot result.</p><pre class="codeinput">portfolio_weight_ts = fints(Xfts.dates,bsxfun(@times, ones(length(Xfts),length(swgt)),swgt'));
portfolio_rt_ts = fun_portfolio_return(Xfts, portfolio_weight_ts);
plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;
plot(log(Xfts)-log(100));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_08.png" alt=""> <p>factor portfolios all has very low volatility. I need a lot of leverage to amplify its risk to target level. since all factor portfolio are close to capital neutral, the capital requirement is merely for margins. can we learned anything here?</p><h2>Combined factor portfolio with Market<a name="17"></a></h2><p>put factor portfolio in order.</p><pre class="codeinput">FactorList = {<span class="string">'MOM'</span>, <span class="string">'HML'</span>, <span class="string">'SML'</span>, <span class="string">'BAB'</span>,<span class="string">'QUAL'</span>,<span class="string">'MKT'</span>};

d = portfolio_cap_ts{1}.dates;
Xfts = fints(d, zeros(numel(d),6), FactorList);

Xfts.MOM  = fts2mat(portfolio_cap_ts{1});
Xfts.HML  = fts2mat(portfolio_cap_ts{2});
Xfts.SML  = fts2mat(portfolio_cap_ts{3});
Xfts.BAB  = fts2mat(portfolio_cap_ts{4});
Xfts.QUAL = fts2mat(portfolio_cap_ts{5});
Xfts.MKT = fts2mat(benchmark_ts{1});

plot(log(Xfts));
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_09.png" alt=""> <p>cash and market</p><pre class="codeinput">market_return = mean(fts2mat(tick2ret(benchmark_ts{1})));
market_vol = std(fts2mat(tick2ret(benchmark_ts{1})));

cash_return = 0.0008;
cash_vol = 0.0016;
</pre><p>estimate asset mean and covariance</p><pre class="codeinput">p = Portfolio(<span class="string">'AssetList'</span>, FactorList, <span class="string">'RiskFreeRate'</span>, cash_return);

p = estimateAssetMoments(p, Xfts, <span class="string">'dataformat'</span>, <span class="string">'prices'</span>);


p = setInitPort(p, 1/p.NumAssets);

[equal_weight_vol, equal_weight_return] = estimatePortMoments(p, p.InitPort);
</pre><p>plot</p><pre class="codeinput">figure;
clf;
portfolioexamples_plot(<span class="string">'Asset Risks and Returns'</span>, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, market_vol, market_return, {<span class="string">'Market'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, cash_vol, cash_return, {<span class="string">'Cash'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, equal_weight_vol, equal_weight_return, {<span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_10.png" alt=""> <p>optimze the portfolio</p><pre class="codeinput">p = setDefaultConstraints(p);

pwgt = estimateFrontier(p, 40);
[prsk, pret] = estimatePortMoments(p, pwgt);


clf;
portfolioexamples_plot(<span class="string">'Efficient Frontier'</span>, <span class="keyword">...</span>
	{<span class="string">'line'</span>, prsk, pret}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {<span class="string">'Market'</span>, <span class="string">'Cash'</span>, <span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_11.png" alt=""> <p>maximize sharpe ratio</p><pre class="codeinput">q = setBudget(p, 0, 1);

qwgt = estimateFrontier(q, 20);
[qrsk, qret] = estimatePortMoments(q, qwgt);

<span class="comment">% Plot efficient frontier with tangent line (0 to 1 cash)</span>

clf;
portfolioexamples_plot(<span class="string">'Efficient Frontier with Tangent Line'</span>, <span class="keyword">...</span>
	{<span class="string">'line'</span>, prsk, pret}, <span class="keyword">...</span>
	{<span class="string">'line'</span>, qrsk, qret, [], [], 1}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {<span class="string">'Market'</span>, <span class="string">'Cash'</span>, <span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});



p = setInitPort(p, 0);
swgt = estimateMaxSharpeRatio(p);
[srsk, sret] = estimatePortMoments(p, swgt);

disp(swgt);
disp(sqrt(12)*sret/srsk);
</pre><pre class="codeoutput">    0.2166
         0
    0.3919
    0.0620
    0.2688
    0.0606

    1.7005

</pre><img vspace="5" hspace="5" src="CombinedFactors_1_12.png" alt=""> <p>plot result.</p><pre class="codeinput">portfolio_weight_ts = fints(Xfts.dates,bsxfun(@times, ones(length(Xfts),length(swgt)),swgt'));
portfolio_rt_ts = fun_portfolio_return(Xfts, portfolio_weight_ts);
plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;
plot(log(Xfts)-log(100));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_13.png" alt=""> <h2>Topm combined factor portfolio<a name="25"></a></h2><p>I know that topm factor portfolio has stronger signal and high vol, let's check those out.</p><p>Market neutral factor portfolios</p><pre class="codeinput">hedge_ratio = [0.82 1.47 1.57 0.70 0.88];

i = 1;
<span class="keyword">while</span> i&lt;=5


  <span class="comment">% load benchmark</span>

  portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},<span class="string">'equalweight'</span>);
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts);
  benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
  benchmark_ts{i} = fints(px.dates, benchmark,<span class="string">'EqualWeightIndex'</span>);


  <span class="comment">% calculate factor portfolio</span>
  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},<span class="string">'topmlongonly'</span>,0.2);
  portfolio_cap_ts{i} = fun_sequential_backtest_partial(100, px, benchmark_ts{i}, hedge_ratio(i), portfolio_weight_ts,false);

  correlation_matrix = corrcoef(fts2mat(tick2ret(portfolio_cap_ts{i})), fts2mat(tick2ret(benchmark_ts{i})));
  correlation(i) = correlation_matrix(1,2);
  sharpe_ratio(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts{i})),0);
  vol(i) = sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts{i})));

  i = i+1;

<span class="keyword">end</span>

12*mean([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
corrcoef([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
12*cov([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])

plot(correlation);
snapnow;
plot(sharpe_ratio);
snapnow;
plot(vol);
snapnow;
</pre><pre class="codeoutput">
ans =

    0.0706   -0.0026    0.0360    0.0115    0.0632


ans =

    1.0000   -0.5488   -0.2467    0.2442    0.0874
   -0.5488    1.0000    0.5780   -0.3087   -0.0838
   -0.2467    0.5780    1.0000   -0.1546   -0.0678
    0.2442   -0.3087   -0.1546    1.0000   -0.0366
    0.0874   -0.0838   -0.0678   -0.0366    1.0000


ans =

    0.0106   -0.0063   -0.0025    0.0014    0.0012
   -0.0063    0.0124    0.0064   -0.0019   -0.0013
   -0.0025    0.0064    0.0099   -0.0009   -0.0009
    0.0014   -0.0019   -0.0009    0.0031   -0.0003
    0.0012   -0.0013   -0.0009   -0.0003    0.0192

</pre><img vspace="5" hspace="5" src="CombinedFactors_1_14.png" alt=""> <img vspace="5" hspace="5" src="CombinedFactors_1_15.png" alt=""> <img vspace="5" hspace="5" src="CombinedFactors_1_16.png" alt=""> <p>put factor portfolio in order.</p><pre class="codeinput">FactorList = {<span class="string">'MOM'</span>, <span class="string">'HML'</span>, <span class="string">'SML'</span>, <span class="string">'BAB'</span>,<span class="string">'QUAL'</span>};

d = portfolio_cap_ts{1}.dates;
Xfts = fints(d, zeros(numel(d),5), FactorList);

Xfts.MOM  = fts2mat(portfolio_cap_ts{1});
Xfts.HML  = fts2mat(portfolio_cap_ts{2});
Xfts.SML  = fts2mat(portfolio_cap_ts{3});
Xfts.BAB  = fts2mat(portfolio_cap_ts{4});
Xfts.QUAL = fts2mat(portfolio_cap_ts{5});


plot(log(Xfts));
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_17.png" alt=""> <p>cash and market</p><pre class="codeinput">market_return = mean(fts2mat(tick2ret(benchmark_ts{1})));
market_vol = std(fts2mat(tick2ret(benchmark_ts{1})));

cash_return = 0.0008;
cash_vol = 0.0016;
</pre><p>estimate asset mean and covariance</p><pre class="codeinput">p = Portfolio(<span class="string">'AssetList'</span>, FactorList, <span class="string">'RiskFreeRate'</span>, cash_return);

p = estimateAssetMoments(p, Xfts, <span class="string">'dataformat'</span>, <span class="string">'prices'</span>);


p = setInitPort(p, 1/p.NumAssets);

[equal_weight_vol, equal_weight_return] = estimatePortMoments(p, p.InitPort);
</pre><p>plot</p><pre class="codeinput">figure;
clf;
portfolioexamples_plot(<span class="string">'Asset Risks and Returns'</span>, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, market_vol, market_return, {<span class="string">'Market'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, cash_vol, cash_return, {<span class="string">'Cash'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, equal_weight_vol, equal_weight_return, {<span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_18.png" alt=""> <p>optimze the portfolio</p><pre class="codeinput">p = setDefaultConstraints(p);

pwgt = estimateFrontier(p, 40);
[prsk, pret] = estimatePortMoments(p, pwgt);


clf;
portfolioexamples_plot(<span class="string">'Efficient Frontier'</span>, <span class="keyword">...</span>
	{<span class="string">'line'</span>, prsk, pret}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {<span class="string">'Market'</span>, <span class="string">'Cash'</span>, <span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_19.png" alt=""> <p>maximize sharpe ratio</p><pre class="codeinput">q = setBudget(p, 0, 1);

qwgt = estimateFrontier(q, 20);
[qrsk, qret] = estimatePortMoments(q, qwgt);

<span class="comment">% Plot efficient frontier with tangent line (0 to 1 cash)</span>

clf;
portfolioexamples_plot(<span class="string">'Efficient Frontier with Tangent Line'</span>, <span class="keyword">...</span>
	{<span class="string">'line'</span>, prsk, pret}, <span class="keyword">...</span>
	{<span class="string">'line'</span>, qrsk, qret, [], [], 1}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {<span class="string">'Market'</span>, <span class="string">'Cash'</span>, <span class="string">'Equal'</span>}}, <span class="keyword">...</span>
	{<span class="string">'scatter'</span>, sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, <span class="string">'.r'</span>});



p = setInitPort(p, 0);
swgt = estimateMaxSharpeRatio(p);
[srsk, sret] = estimatePortMoments(p, swgt);

disp(swgt);
disp(sqrt(12)*sret/srsk);
</pre><pre class="codeoutput">    0.4777
    0.0343
    0.3050
         0
    0.1829

    0.9799

</pre><img vspace="5" hspace="5" src="CombinedFactors_1_20.png" alt=""> <p>plot result.</p><pre class="codeinput">portfolio_weight_ts = fints(Xfts.dates,bsxfun(@times, ones(length(Xfts),length(swgt)),swgt'));
portfolio_rt_ts = fun_portfolio_return(Xfts, portfolio_weight_ts);
plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;
plot(log(Xfts)-log(100));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="CombinedFactors_1_21.png" alt=""> <p>Sharpe 1~1.5 can be expected.</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Combined Factors  -  In theory 2

%% Preparation
% Let's load the data from ..

load('../data_equity_list_us.mat'); 
load('../data_field_list.mat'); 
load('../data_historical_data_us.mat'); 



%%
% take data sample, load data & the list
index = datasample(1:1300,1000,'Replace',false); 
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px); 
list = equity_list_us(index,:); 

%%
% load observations

mom_ts          = fun_calculate_mom(px); 

pb_ts           = fun_load_observations(history_us, equity_list_us, index,'pb'); 
cap_ts          = fun_load_observations(history_us, equity_list_us, index,'cap'); 
beta_ts         = fun_load_observations(history_us, equity_list_us, index,'beta'); 

grossmargin_ts  = fun_load_observations(history_us, equity_list_us, index,'gm');
turnover_ts     = fun_load_observations(history_us, equity_list_us, index,'turnover');
roa_ts          = fun_load_observations(history_us, equity_list_us, index,'roa');
leverage_ts     = fun_load_observations(history_us, equity_list_us, index,'leverage');

%%
% calculate score

score_mom_ts          =   fun_calculate_score(mom_ts,list,'sectorsort',px);

score_pb_ts           =   -fun_calculate_score(pb_ts,list,'sectorsort',px); 
score_cap_ts          =   -fun_calculate_score(cap_ts,list,'sectorsort',px); 
score_beta_ts         =   -fun_calculate_score(beta_ts,list,'sectorsort',px);


score_leverage_ts     =   -fun_calculate_score(leverage_ts,list,'sectorsort',px);
score_roa_ts          =   fun_calculate_score(roa_ts,list,'sectorsort',px);
score_grossmargin_ts  =   fun_calculate_score(grossmargin_ts,list,'sectorsort',px);
score_turnover_ts     =   fun_calculate_score(turnover_ts,list,'sectorsort',px);

score_quality_ts      =   score_leverage_ts+score_roa_ts+score_grossmargin_ts+score_turnover_ts;
score_quality_ts      =   fun_combine_score(score_quality_ts);




%%  
% Trim

score_mom_ts      = score_mom_ts(75:end); 
score_pb_ts       = score_pb_ts(75:end); 
score_cap_ts      = score_cap_ts(75:end); 
score_beta_ts     = score_beta_ts(75:end); 
score_quality_ts  = score_quality_ts(75:end); 

score_ts = {score_mom_ts; score_pb_ts; score_cap_ts; score_beta_ts; score_quality_ts};

px = px(75:end); 

%% Generate factor portfolio
% 

%% 
% Market neutral factor portfolios

hedge_ratio = [0.82 1.25 1.25 0.73 0.88]; 

i = 1; 
while i<=5
  
  
  % load benchmark 

  portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},'equalweight'); 
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts); 
  benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
  benchmark_ts{i} = fints(px.dates, benchmark,'EqualWeightIndex'); 

  
  % calculate factor portfolio
  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},'longonly'); 
  portfolio_cap_ts{i} = fun_sequential_backtest_partial(100, px, benchmark_ts{i}, hedge_ratio(i), portfolio_weight_ts,false);

  correlation_matrix = corrcoef(fts2mat(tick2ret(portfolio_cap_ts{i})), fts2mat(tick2ret(benchmark_ts{i})));
  correlation(i) = correlation_matrix(1,2); 
  sharpe_ratio(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts{i})),0);
  vol(i) = sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts{i}))); 
  
  i = i+1;
  
end

12*mean([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
corrcoef([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
12*cov([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])


plot(correlation); 
snapnow; 
plot(sharpe_ratio); 
snapnow;
plot(vol); 
snapnow; 
%% Combined Factor portfolios 
% 

%%
% put factor portfolio in order. 
FactorList = {'MOM', 'HML', 'SML', 'BAB','QUAL'};

d = portfolio_cap_ts{1}.dates; 
Xfts = fints(d, zeros(numel(d),5), FactorList);

Xfts.MOM  = fts2mat(portfolio_cap_ts{1}); 
Xfts.HML  = fts2mat(portfolio_cap_ts{2}); 
Xfts.SML  = fts2mat(portfolio_cap_ts{3}); 
Xfts.BAB  = fts2mat(portfolio_cap_ts{4}); 
Xfts.QUAL = fts2mat(portfolio_cap_ts{5}); 


plot(log(Xfts)); 
legend('location','northwest'); 

%%
% cash and market
market_return = mean(fts2mat(tick2ret(benchmark_ts{1})));
market_vol = std(fts2mat(tick2ret(benchmark_ts{1})));

cash_return = 0.0008; 
cash_vol = 0.0016;

%%
% estimate asset mean and covariance

p = Portfolio('AssetList', FactorList, 'RiskFreeRate', cash_return);

p = estimateAssetMoments(p, Xfts, 'dataformat', 'prices');


p = setInitPort(p, 1/p.NumAssets);

[equal_weight_vol, equal_weight_return] = estimatePortMoments(p, p.InitPort);
%%
% plot 

figure;
clf;
portfolioexamples_plot('Asset Risks and Returns', ...
	{'scatter', market_vol, market_return, {'Market'}}, ...
	{'scatter', cash_vol, cash_return, {'Cash'}}, ...
	{'scatter', equal_weight_vol, equal_weight_return, {'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});


%%
% optimze the portfolio

p = setDefaultConstraints(p);

pwgt = estimateFrontier(p, 40);
[prsk, pret] = estimatePortMoments(p, pwgt);


clf;
portfolioexamples_plot('Efficient Frontier', ...
	{'line', prsk, pret}, ...
	{'scatter', [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {'Market', 'Cash', 'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});

%%
% maximize sharpe ratio


q = setBudget(p, 0, 1);

qwgt = estimateFrontier(q, 20);
[qrsk, qret] = estimatePortMoments(q, qwgt);

% Plot efficient frontier with tangent line (0 to 1 cash)

clf;
portfolioexamples_plot('Efficient Frontier with Tangent Line', ...
	{'line', prsk, pret}, ...
	{'line', qrsk, qret, [], [], 1}, ...
	{'scatter', [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {'Market', 'Cash', 'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});



p = setInitPort(p, 0);
swgt = estimateMaxSharpeRatio(p);
[srsk, sret] = estimatePortMoments(p, swgt);

disp(swgt); 
disp(sqrt(12)*sret/srsk);

%%
% plot result. 

portfolio_weight_ts = fints(Xfts.dates,bsxfun(@times, ones(length(Xfts),length(swgt)),swgt'));
portfolio_rt_ts = fun_portfolio_return(Xfts, portfolio_weight_ts); 
plot(cumsum(portfolio_rt_ts)); 
legend('off');
hold on;
plot(log(Xfts)-log(100));
legend('off');
hold off; 

%%
% factor portfolios all has very low volatility. I need a lot of leverage to amplify its risk to target level. 
% since all factor portfolio are close to capital neutral, the capital requirement is merely for margins. can we learned anything here?

%% Combined factor portfolio with Market
%


%%
% put factor portfolio in order. 
FactorList = {'MOM', 'HML', 'SML', 'BAB','QUAL','MKT'};

d = portfolio_cap_ts{1}.dates; 
Xfts = fints(d, zeros(numel(d),6), FactorList);

Xfts.MOM  = fts2mat(portfolio_cap_ts{1}); 
Xfts.HML  = fts2mat(portfolio_cap_ts{2}); 
Xfts.SML  = fts2mat(portfolio_cap_ts{3}); 
Xfts.BAB  = fts2mat(portfolio_cap_ts{4}); 
Xfts.QUAL = fts2mat(portfolio_cap_ts{5}); 
Xfts.MKT = fts2mat(benchmark_ts{1}); 

plot(log(Xfts)); 

%%
% cash and market
market_return = mean(fts2mat(tick2ret(benchmark_ts{1})));
market_vol = std(fts2mat(tick2ret(benchmark_ts{1})));

cash_return = 0.0008; 
cash_vol = 0.0016;

%%
% estimate asset mean and covariance

p = Portfolio('AssetList', FactorList, 'RiskFreeRate', cash_return);

p = estimateAssetMoments(p, Xfts, 'dataformat', 'prices');


p = setInitPort(p, 1/p.NumAssets);

[equal_weight_vol, equal_weight_return] = estimatePortMoments(p, p.InitPort);
%%
% plot 

figure;
clf;
portfolioexamples_plot('Asset Risks and Returns', ...
	{'scatter', market_vol, market_return, {'Market'}}, ...
	{'scatter', cash_vol, cash_return, {'Cash'}}, ...
	{'scatter', equal_weight_vol, equal_weight_return, {'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});


%%
% optimze the portfolio

p = setDefaultConstraints(p);

pwgt = estimateFrontier(p, 40);
[prsk, pret] = estimatePortMoments(p, pwgt);


clf;
portfolioexamples_plot('Efficient Frontier', ...
	{'line', prsk, pret}, ...
	{'scatter', [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {'Market', 'Cash', 'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});

%%
% maximize sharpe ratio


q = setBudget(p, 0, 1);

qwgt = estimateFrontier(q, 20);
[qrsk, qret] = estimatePortMoments(q, qwgt);

% Plot efficient frontier with tangent line (0 to 1 cash)

clf;
portfolioexamples_plot('Efficient Frontier with Tangent Line', ...
	{'line', prsk, pret}, ...
	{'line', qrsk, qret, [], [], 1}, ...
	{'scatter', [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {'Market', 'Cash', 'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});



p = setInitPort(p, 0);
swgt = estimateMaxSharpeRatio(p);
[srsk, sret] = estimatePortMoments(p, swgt);

disp(swgt); 
disp(sqrt(12)*sret/srsk);


%%
% plot result. 

portfolio_weight_ts = fints(Xfts.dates,bsxfun(@times, ones(length(Xfts),length(swgt)),swgt'));
portfolio_rt_ts = fun_portfolio_return(Xfts, portfolio_weight_ts); 
plot(cumsum(portfolio_rt_ts)); 
legend('off');
hold on;
plot(log(Xfts)-log(100));
legend('off');
hold off; 


%% Topm combined factor portfolio
% I know that topm factor portfolio has stronger signal and high vol, let's
% check those out. 

%% 
% Market neutral factor portfolios

hedge_ratio = [0.82 1.47 1.57 0.70 0.88]; 

i = 1; 
while i<=5
  
  
  % load benchmark 

  portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},'equalweight'); 
  portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts); 
  benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
  benchmark_ts{i} = fints(px.dates, benchmark,'EqualWeightIndex'); 

  
  % calculate factor portfolio
  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_ts{i},'topmlongonly',0.2); 
  portfolio_cap_ts{i} = fun_sequential_backtest_partial(100, px, benchmark_ts{i}, hedge_ratio(i), portfolio_weight_ts,false);

  correlation_matrix = corrcoef(fts2mat(tick2ret(portfolio_cap_ts{i})), fts2mat(tick2ret(benchmark_ts{i})));
  correlation(i) = correlation_matrix(1,2); 
  sharpe_ratio(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts{i})),0);
  vol(i) = sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts{i}))); 
  
  i = i+1;
  
end

12*mean([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
corrcoef([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])
12*cov([fts2mat(tick2ret(portfolio_cap_ts{1})) fts2mat(tick2ret(portfolio_cap_ts{2})) fts2mat(tick2ret(portfolio_cap_ts{3})) fts2mat(tick2ret(portfolio_cap_ts{4})) fts2mat(tick2ret(portfolio_cap_ts{5}))])

plot(correlation); 
snapnow; 
plot(sharpe_ratio); 
snapnow;
plot(vol); 
snapnow; 
%%
% put factor portfolio in order. 
FactorList = {'MOM', 'HML', 'SML', 'BAB','QUAL'};

d = portfolio_cap_ts{1}.dates; 
Xfts = fints(d, zeros(numel(d),5), FactorList);

Xfts.MOM  = fts2mat(portfolio_cap_ts{1}); 
Xfts.HML  = fts2mat(portfolio_cap_ts{2}); 
Xfts.SML  = fts2mat(portfolio_cap_ts{3}); 
Xfts.BAB  = fts2mat(portfolio_cap_ts{4}); 
Xfts.QUAL = fts2mat(portfolio_cap_ts{5}); 


plot(log(Xfts)); 
%%
% cash and market
market_return = mean(fts2mat(tick2ret(benchmark_ts{1})));
market_vol = std(fts2mat(tick2ret(benchmark_ts{1})));

cash_return = 0.0008; 
cash_vol = 0.0016;

%%
% estimate asset mean and covariance

p = Portfolio('AssetList', FactorList, 'RiskFreeRate', cash_return);

p = estimateAssetMoments(p, Xfts, 'dataformat', 'prices');


p = setInitPort(p, 1/p.NumAssets);

[equal_weight_vol, equal_weight_return] = estimatePortMoments(p, p.InitPort);
%%
% plot 

figure;
clf;
portfolioexamples_plot('Asset Risks and Returns', ...
	{'scatter', market_vol, market_return, {'Market'}}, ...
	{'scatter', cash_vol, cash_return, {'Cash'}}, ...
	{'scatter', equal_weight_vol, equal_weight_return, {'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});


%%
% optimze the portfolio

p = setDefaultConstraints(p);

pwgt = estimateFrontier(p, 40);
[prsk, pret] = estimatePortMoments(p, pwgt);


clf;
portfolioexamples_plot('Efficient Frontier', ...
	{'line', prsk, pret}, ...
	{'scatter', [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {'Market', 'Cash', 'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});

%%
% maximize sharpe ratio


q = setBudget(p, 0, 1);

qwgt = estimateFrontier(q, 20);
[qrsk, qret] = estimatePortMoments(q, qwgt);

% Plot efficient frontier with tangent line (0 to 1 cash)

clf;
portfolioexamples_plot('Efficient Frontier with Tangent Line', ...
	{'line', prsk, pret}, ...
	{'line', qrsk, qret, [], [], 1}, ...
	{'scatter', [market_vol, cash_vol, equal_weight_vol], [market_return, cash_return, equal_weight_return], {'Market', 'Cash', 'Equal'}}, ...
	{'scatter', sqrt(diag(p.AssetCovar)), p.AssetMean, p.AssetList, '.r'});



p = setInitPort(p, 0);
swgt = estimateMaxSharpeRatio(p);
[srsk, sret] = estimatePortMoments(p, swgt);

disp(swgt); 
disp(sqrt(12)*sret/srsk);


%%
% plot result. 

portfolio_weight_ts = fints(Xfts.dates,bsxfun(@times, ones(length(Xfts),length(swgt)),swgt'));
portfolio_rt_ts = fun_portfolio_return(Xfts, portfolio_weight_ts); 
plot(cumsum(portfolio_rt_ts)); 
legend('off');
hold on;
plot(log(Xfts)-log(100));
legend('off');
hold off; 


%%
% Sharpe 1~1.5 can be expected.
##### SOURCE END #####
--></body></html>
  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">nion</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>nion</li>
          <li><a href="mailto:iam@here.now">iam@here.now</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/yuanhangw">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">yuanhangw</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/large">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">large</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">keep it simple :: finish it off :: iterate
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
