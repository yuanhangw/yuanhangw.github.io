<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Multiple Factors - HML updated with Risk adjustment</title>
    <meta name="description" content="keep it simple :: finish it off :: iterate
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://yuanhangw.github.com/html/MultipleFactors_1.html">
</head>


  
  <body>

    <header class="site-header">

  <div class="wrapper">
  


    
    <a class="site-title" href="/"> 
    <img class ="logo" src="/Mobius.jpg" alt="" height="50" width="50">nion</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      
      <!--
      <div class="trigger">
        
          
          <a class="page-link" href="/html/CombinedFactor_7.html">Combined Factors - Constant dripping wears away a stone.</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_1.html">Combined Factors - Theory mixed with a little bit of reality</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_2.html">Combined Factors - Policy Portfolios</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_3.html">Combined Factors - Policy Portfolios with large dataset</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_4.html">Combined Factors - The Dark Force is Strong</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_5.html">Combined Factors - Fillts() or not Fillts(), That is the questoin</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_6.html">Combined Factors - Detail! Detail! Detail!</a>
          
        
          
          <a class="page-link" href="/html/CombinedFactors_toolbox.html">Combined Factors - In theory ...</a>
          
        
          
          <a class="page-link" href="/html/ExpectedMaximumDrawDown.html">Drawdown</a>
          
        
          
          <a class="page-link" href="/html/FREDData.html">Retrieve data from FRED database</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors.html">Multiple Factors - Load Data</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_1.html">Multiple Factors - HML updated with Risk adjustment</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_2.html">Multiple Factors - SML adjust for risk</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_3.html">Multiple Factors - BAB watch out for correlation</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_4.html">Multiple Factors - QUAL - Quality is underated</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_5.html">Multiple Factors - Revisit MOM</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_6.html">Multiple Factors - Sanity Check</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_7.html">Multiple Factors - All in one</a>
          
        
          
          <a class="page-link" href="/html/MultipleFactors_8.html">Multiple Factors - Bigger All in one</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor.html">Introducing Mother of all Factors - MOM</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_1.html">MOM factor walkforward</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_2.html">MOM too good to be true?</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_3.html">MOM 2->N</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_4.html">MOM short Cap weighted index?</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_5.html">MOM walkforward with N securities</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_6.html">MOM sector neutral</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_7.html">MOM alternative MOM</a>
          
        
          
          <a class="page-link" href="/html/SimpleMomentumFactor_8.html">MOM the bigger the better?</a>
          
        
          
          <a class="page-link" href="/html/WhatInMyDataSet.html">What's in my dataset</a>
          
        
          
          <a class="page-link" href="/html/WhatInMyEquityList.html">Equity List and Field List</a>
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/post.html">Post</a>
          
        
      </div>
      -->
      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/post.html">Post</a>
          
        
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Multiple Factors - HML updated with Risk adjustment</h1>
  </header>

  <article class="post-content">
    <!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Multiple Factors - HML</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-01-28"><meta name="DC.source" content="MultipleFactors_1.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Multiple Factors - HML</h1><!--introduction--><p>HML is one of the simplest factors. Let's take a look.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Load Data</a></li><li><a href="#9">Check signal.</a></li><li><a href="#22">Percentile analysis</a></li><li><a href="#26">Update the result with risk adjustment</a></li><li><a href="#38">Large dataset test</a></li><li><a href="#49">Update large dataset result with risk adjustment</a></li></ul></div><h2>Load Data<a name="1"></a></h2><p>Let's load the data from ..</p><pre class="codeinput">load(<span class="string">'../data_equity_list_us.mat'</span>);
load(<span class="string">'../data_field_list.mat'</span>);
load(<span class="string">'../data_historical_data_us.mat'</span>);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index = datasample(1:1300,1000,<span class="string">'Replace'</span>,false);
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px);
list = equity_list_us(index,:);
</pre><p>load the PB ratios</p><pre class="codeinput">pb_ts = fun_load_observations(history_us, equity_list_us, index,<span class="string">'pb'</span>);
</pre><p>I have looked at the medium PB previously</p><pre class="codeinput">plot(pb_ts.dates,nanmedian(fts2mat(pb_ts),2));
datetick(<span class="string">'x'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_01.png" alt=""> <p>pb data is not available for most equty until late 80s.</p><p>let's take a look at the full dataset.</p><pre class="codeinput">plot(pb_ts.dates,fts2mat(pb_ts));
datetick(<span class="string">'x'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_02.png" alt=""> <p>I can clean up the pb data for extreme value, but I prefer to leave it intact. Since we cleaned up price data, let's see what's the corresponding pb data looks like</p><pre class="codeinput">pb_mat = fts2mat(pb_ts);
px_mat = fts2mat(px);

pb_mat(isnan(px_mat))=nan;

plot(pb_ts.dates,pb_mat);
datetick(<span class="string">'x'</span>);
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_03.png" alt=""> <p>much better.</p><h2>Check signal.<a name="9"></a></h2><p>Does low valuation securites out perform on risk adjust basis? Let's compare portfolio constructed using only low pb stocks v.s. is equal weighted conterpart.</p><pre class="codeinput">score_pb_ts = -fun_calculate_score(pb_ts,list,<span class="string">'fullsort'</span>,px);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longonly'</span>);
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);
</pre><p>let's check the result.</p><pre class="codeinput">plot(cumsum(portfolio_longonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts(50:end)),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_04.png" alt=""> <pre class="codeoutput">
ans =

    0.5195    0.6226

</pre><p>doesn't seems to be very promising.</p><p>let's take a look at the sector sorted portfolio</p><pre class="codeinput">score_pb_ts = -fun_calculate_score(pb_ts,list,<span class="string">'sectorsort'</span>,px);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longonly'</span>);
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

<span class="comment">% let's check the result.</span>
plot(cumsum(portfolio_longonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_05.png" alt=""> <pre class="codeoutput">
ans =

    0.5481    0.6282

</pre><p>sector weight give me a more balance portfolio and improved the sharpe by 5 basis points. most of the outperformance came in after dotcom bubble.</p><p>HML is very different from MOM. even though the long only portfolio outperformed equal weighted portfolio, in terms of sharpe it is worse. The outperformance is gained by assuming more 'risk'.</p><p>There is a slightly tricky question here. what extra 'risk' is it? if it is market risk, then HML is useless. but if it is another type of risk different from market risk, then it might be useful from diversification point of view.</p><p>with this question in mind, let's check pure long short factor portfolio against equal weighted market portfolio.</p><pre class="codeinput">score_pb_ts = -fun_calculate_score(pb_ts,list,<span class="string">'sectorsort'</span>,px);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longshort'</span>);
portfolio_longshort_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

<span class="comment">% let's check the result.</span>
plot(cumsum(portfolio_longshort_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(cumsum(portfolio_equalweight_rt_ts));
legend(<span class="string">'off'</span>);

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_06.png" alt=""> <pre class="codeoutput">
ans =

    0.0847    0.6282

</pre><p>if additional risk is mainly market risk, then long short portfolio should be highly correlated with equal weighted benchmark. let's check out the correlation:</p><pre class="codeinput">corrcoef(fts2mat(portfolio_longshort_rt_ts(1:end)), fts2mat(portfolio_equalweight_rt_ts(1:end)))
</pre><pre class="codeoutput">
ans =

    1.0000    0.5116
    0.5116    1.0000

</pre><p>the correlation is quite high... this is not what I expected, but let's accept the facts.</p><p>let's see how the top percentile securities do</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topm'</span>,0.2);
portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmlongonly'</span>,0.2);
portfolio_topmlongonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

<span class="comment">% let's check the result.</span>
plot(cumsum(portfolio_topm_rt_ts));
legend(<span class="string">'off'</span>);

plot(cumsum(portfolio_topmlongonly_rt_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;

snapnow;

[sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0)]
[sqrt(12)*sharpe(fts2mat(portfolio_topmlongonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_07.png" alt=""> <pre class="codeoutput">
ans =

    0.3179    0.0847


ans =

    0.5387    0.6282

</pre><p>the drawdown is huge for top 20%, 63%(!) in 2008. 10% more than equal weighted index...</p><pre class="codeinput">maxdrawdown(exp(fts2mat(cumsum(portfolio_topmlongonly_rt_ts))))
maxdrawdown(exp(fts2mat(cumsum(portfolio_equalweight_rt_ts))))
</pre><pre class="codeoutput">
ans =

    0.6837


ans =

    0.5937

</pre><p>I can check my historical portfolio pb and compare that to the market median.</p><pre class="codeinput">score_mat = fts2mat(score_pb_ts);
pb_mat = fts2mat(pb_ts);
pb_selected = pb_mat;
pb_selected(score_mat&lt;0.2)=nan;

plot(pb_ts.dates,nanmedian(pb_mat,2));
hold <span class="string">on</span>;
plot(pb_ts.dates,nanmedian(pb_selected,2));
hold <span class="string">off</span>;
datetick(<span class="string">'x'</span>);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_08.png" alt=""> <h2>Percentile analysis<a name="22"></a></h2><p>let's take a look at the relationship with N</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topm'</span>,0.1*i);
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_09.png" alt=""> <p>let's take a look at each percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmn'</span>,0.1*i,0.1*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_10.png" alt=""> <p>zoom in</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmn'</span>,0.01*i,0.01*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_11.png" alt=""> <p>signal strength</p><pre class="codeinput">plot(sharpe_top);
hold <span class="string">on</span>;
plot(sharpe_top_percentile);
plot(sharpe_top_percentile_zoom);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_12.png" alt=""> <h2>Update the result with risk adjustment<a name="26"></a></h2><p>let's generate the benchmark first</p><pre class="codeinput">portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'equalweight'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts);
benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts = fints(px.dates, benchmark,<span class="string">'EqualWeightIndex'</span>);


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmlongonly'</span>,0.1);

portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),true);

plot(log(benchmark_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_13.png" alt=""> <p>sharpe &amp; vol</p><pre class="codeinput">[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(benchmark_ts)),0)]
[sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts))) sqrt(12)*std(fts2mat(tick2ret(benchmark_ts)))]
</pre><pre class="codeoutput">
ans =

    0.7043    0.7193


ans =

    0.3098    0.1891

</pre><p>let's take a look at the risk adjusted v.s. the capital hedged.</p><pre class="codeinput">portfolio_cap_factor_1_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);
portfolio_cap_factor_2_ts = fun_sequential_backtest_partial(100, px(50:end), benchmark_ts(50:end),1, portfolio_weight_ts(50:end),false);

plot(log(portfolio_cap_factor_1_ts));
legend(<span class="string">'off'</span>);

plot(log(portfolio_cap_factor_2_ts));
legend(<span class="string">'off'</span>);

snapnow;
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_14.png" alt=""> <p>sharpe &amp; correlation</p><pre class="codeinput">[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),0)]

corrcoef(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),fts2mat(tick2ret(benchmark_ts(50:end))))
corrcoef(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),fts2mat(tick2ret(benchmark_ts(50:end))))
</pre><pre class="codeoutput">
ans =

    0.1507    0.4972


ans =

    1.0000   -0.0314
   -0.0314    1.0000


ans =

    1.0000    0.5626
    0.5626    1.0000

</pre><p>so there is in fact no signal in top 0.1 ... on risk adjusted basis.</p><p>let's run the percentile analysis.</p><p>top N</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmlongonly'</span>,0.1*i);
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(50:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile)
snapnow;


plot(correlation)
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_15.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_16.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_17.png" alt=""> <p>it now looks very different from the unadjusted result.</p><p>breakdown into percentile.</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmnlongonly'</span>,0.1*i,0.1*(i-1));
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(50:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile)
snapnow;


plot(correlation)
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_18.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_19.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_20.png" alt=""> <p>so if there is no positive drift on risk adjusted basis, then what's the point to include HML in the portfolio? as diversifier and a timing signal?</p><h2>Large dataset test<a name="38"></a></h2><p>load the big dataset</p><pre class="codeinput">load(<span class="string">'../Big Data/data_equity_list.mat'</span>);
load(<span class="string">'../Big Data/data_historical_data_jan16.mat'</span>);

equity_list = equity_list(1:size(storage0,1),:);

equity_list_us_large = equity_list(strcmp(equity_list(:,2),<span class="string">'US'</span>),:);
history_us_large = storage0(strcmp(equity_list(:,2),<span class="string">'US'</span>),:);

clear <span class="string">storage0</span>;
clear <span class="string">equity_list</span>;

equity_list_us_large = equity_list_us_large(not(cellfun(@isempty,history_us_large(:,1))),:);
history_us_large = history_us_large(not(cellfun(@isempty,history_us_large(:,1))),:);
</pre><p>take data sample, load data &amp; the list</p><pre class="codeinput">index_large = datasample(1:8900,8001,<span class="string">'Replace'</span>,false);
px_large = fun_load_price_large(history_us_large, equity_list_us_large, index_large);
px_large = fun_clean_data(px_large);
list_large = equity_list_us_large(index_large,:);
</pre><p>load the PB ratios</p><pre class="codeinput">pb_ts_large = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,<span class="string">'pb'</span>);
</pre><p>calculate score</p><pre class="codeinput">score_pb_ts_large = -fun_calculate_score(pb_ts_large,list_large,<span class="string">'sectorsort'</span>,px_large);
</pre><p>compare the result:</p><p>pure long short</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'longshort'</span>);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)
hold <span class="string">on</span>;

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'longshort'</span>);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)

hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_21.png" alt=""> <p>pure top 10%</p><pre class="codeinput">portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topm'</span>,0.1);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)
hold <span class="string">on</span>;

sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmn'</span>,0.1,0.02);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)

sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topm'</span>,0.1);
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts);

plot(cumsum(portfolio_rt_ts));
legend(<span class="string">'off'</span>)

hold <span class="string">off</span>;

sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)
</pre><pre class="codeoutput">
ans =

    0.5129


ans =

    0.5663


ans =

    0.3796

</pre><img vspace="5" hspace="5" src="MultipleFactors_1_22.png" alt=""> <p>each percentile</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmn'</span>,0.1*i,0.1*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile_large(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_top_percentile_large);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_23.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_24.png" alt=""> <p>zoom into first 800</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmn'</span>,0.01*i,0.01*(i-1));
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts);

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_top_percentile_large_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0);

  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_top_percentile_large_zoom);
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_25.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_26.png" alt=""> <p>&gt;&gt;&gt;&gt;similar to MOM, larger dataset doesn't really improve the factor&lt;&lt;&lt;&lt;&lt; This is wrong due to a mistake in generating scores.. larger dataset helps!!</p><h2>Update large dataset result with risk adjustment<a name="49"></a></h2><p>let's generate the benchmark first</p><pre class="codeinput">portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'equalweight'</span>);
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_eq_weight_ts);
benchmark_large = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts_large = fints(px_large.dates, benchmark_large,<span class="string">'EqualWeightIndex'</span>);
</pre><p>let's compare the two benchmark.</p><pre class="codeinput">plot(log(benchmark_ts));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;
plot(log(benchmark_ts_large));
legend(<span class="string">'off'</span>);
hold <span class="string">off</span>;
snapnow;

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmlongonly'</span>,0.1);

portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px_large(50:end), benchmark_ts_large(50:end), portfolio_weight_ts(50:end),true);

plot(log(benchmark_ts_large));
legend(<span class="string">'off'</span>);
hold <span class="string">on</span>;

plot(log(portfolio_cap_ts));
legend(<span class="string">'off'</span>);

snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_27.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_28.png" alt=""> <p>sharpe &amp; vol</p><pre class="codeinput">[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(benchmark_ts)),0)]
[sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts))) sqrt(12)*std(fts2mat(tick2ret(benchmark_ts)))]
</pre><pre class="codeoutput">
ans =

    0.7441    0.7193


ans =

    0.3265    0.1891

</pre><p>let's take a look at the risk adjusted v.s. the capital hedged.</p><pre class="codeinput">portfolio_cap_factor_1_ts = fun_sequential_backtest_autoadjust(100, px_large(50:end), benchmark_ts_large(50:end), portfolio_weight_ts(50:end),false);
portfolio_cap_factor_2_ts = fun_sequential_backtest_partial(100, px_large(50:end), benchmark_ts_large(50:end),1, portfolio_weight_ts(50:end),false);

plot(log(portfolio_cap_factor_1_ts));
legend(<span class="string">'off'</span>);

plot(log(portfolio_cap_factor_2_ts));
legend(<span class="string">'off'</span>);

snapnow;
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_29.png" alt=""> <p>sharpe &amp; correlation</p><pre class="codeinput">[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),0)]

corrcoef(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),fts2mat(tick2ret(benchmark_ts_large(50:end))))
corrcoef(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),fts2mat(tick2ret(benchmark_ts_large(50:end))))
</pre><pre class="codeoutput">
ans =

    0.2338    0.5873


ans =

    1.0000   -0.0408
   -0.0408    1.0000


ans =

    1.0000    0.5623
    0.5623    1.0000

</pre><p>large pool seems matters, we have some positive drift here..</p><p>let's run the percentile analysis.</p><p>top N</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,<span class="string">'topmlongonly'</span>,0.1*i);
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px_large(50:end), benchmark_ts_large(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(50:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile)
snapnow;


plot(correlation)
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_30.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_31.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_32.png" alt=""> <p>it now looks very different from the unadjusted result.</p><p>breakdown into percentile.</p><pre class="codeinput">i=1;
<span class="keyword">while</span> i&lt;=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,<span class="string">'topmnlongonly'</span>,0.1*i,0.1*(i-1));
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts));
  portplot.Color(4) = 1 - 0.1*i;
  hold <span class="string">on</span>;

  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0);
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(50:end))));
  correlation(i) = corr(1,2);
  i = i+1;

<span class="keyword">end</span>

hold <span class="string">off</span>;
snapnow;

plot(sharpe_percentile)
snapnow;


plot(correlation)
snapnow;
</pre><img vspace="5" hspace="5" src="MultipleFactors_1_33.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_34.png" alt=""> <img vspace="5" hspace="5" src="MultipleFactors_1_35.png" alt=""> <p>so if there is no positive drift on risk adjusted basis, then what's the point to include HML in the portfolio? as diversifier and a timing signal?</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Multiple Factors - HML
% HML is one of the simplest factors. Let's take a look. 

%% Load Data
% Let's load the data from ..

load('../data_equity_list_us.mat'); 
load('../data_field_list.mat'); 
load('../data_historical_data_us.mat'); 


%%
% take data sample, load data & the list
index = datasample(1:1300,1000,'Replace',false); 
px = fun_load_price(history_us, equity_list_us, index);
px = fun_clean_data(px); 
list = equity_list_us(index,:); 

%%
% load the PB ratios

pb_ts = fun_load_observations(history_us, equity_list_us, index,'pb'); 


%%
% I have looked at the medium PB previously 

plot(pb_ts.dates,nanmedian(fts2mat(pb_ts),2));
datetick('x'); 
snapnow; 

%%
% pb data is not available for most equty until late 80s. 

%%
% let's take a look at the full dataset. 
 
plot(pb_ts.dates,fts2mat(pb_ts));
datetick('x'); 
snapnow; 

%%
% I can clean up the pb data for extreme value, but I prefer to leave it
% intact. Since we cleaned up price data, let's see what's the
% corresponding pb data looks like

pb_mat = fts2mat(pb_ts); 
px_mat = fts2mat(px);

pb_mat(isnan(px_mat))=nan; 

plot(pb_ts.dates,pb_mat); 
datetick('x'); 

%%
% much better. 

%% Check signal. 
% Does low valuation securites out perform on risk adjust basis? Let's
% compare portfolio constructed using only low pb stocks v.s. is equal
% weighted conterpart. 

score_pb_ts = -fun_calculate_score(pb_ts,list,'fullsort',px); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longonly'); 
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

%%
% let's check the result. 

plot(cumsum(portfolio_longonly_rt_ts)); 
legend('off'); 
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off'); 
hold off; 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts(50:end)),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts(50:end)),0)]

%%
% doesn't seems to be very promising. 

%%
% let's take a look at the sector sorted portfolio

score_pb_ts = -fun_calculate_score(pb_ts,list,'sectorsort',px); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longonly'); 
portfolio_longonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

% let's check the result. 
plot(cumsum(portfolio_longonly_rt_ts)); 
legend('off'); 
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off'); 
hold off; 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_longonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]

%%
% sector weight give me a more balance portfolio and improved the sharpe by
% 5 basis points. most of the outperformance came in after dotcom bubble. 

%%
% HML is very different from MOM. even though the long only portfolio
% outperformed equal weighted portfolio, in terms of sharpe it is worse.
% The outperformance is gained by assuming more 'risk'. 

%%
% There is a slightly tricky question here. what extra 'risk' is it? if it
% is market risk, then HML is useless. but if it is another type of risk
% different from market risk, then it might be useful from diversification
% point of view. 

%%
% with this question in mind, let's check pure long short factor portfolio against equal
% weighted market portfolio. 


score_pb_ts = -fun_calculate_score(pb_ts,list,'sectorsort',px); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longshort'); 
portfolio_longshort_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_equalweight_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

% let's check the result. 
plot(cumsum(portfolio_longshort_rt_ts)); 
legend('off'); 
hold on; 

plot(cumsum(portfolio_equalweight_rt_ts)); 
legend('off'); 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]

%%
% if additional risk is mainly market risk, then long short portfolio
% should be highly correlated with equal weighted benchmark. let's check
% out the correlation:

corrcoef(fts2mat(portfolio_longshort_rt_ts(1:end)), fts2mat(portfolio_equalweight_rt_ts(1:end)))

%%
% the correlation is quite high... this is not what I expected, but let's
% accept the facts. 


%%
% let's see how the top percentile securities do


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topm',0.2); 
portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmlongonly',0.2); 
portfolio_topmlongonly_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

% let's check the result. 
plot(cumsum(portfolio_topm_rt_ts)); 
legend('off'); 

plot(cumsum(portfolio_topmlongonly_rt_ts)); 
legend('off'); 
hold off; 

snapnow; 

[sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_longshort_rt_ts),0)]
[sqrt(12)*sharpe(fts2mat(portfolio_topmlongonly_rt_ts),0) sqrt(12)*sharpe(fts2mat(portfolio_equalweight_rt_ts),0)]

%%
% the drawdown is huge for top 20%, 63%(!) in 2008. 10% more than equal
% weighted index...

maxdrawdown(exp(fts2mat(cumsum(portfolio_topmlongonly_rt_ts))))
maxdrawdown(exp(fts2mat(cumsum(portfolio_equalweight_rt_ts))))

%%
% I can check my historical portfolio pb and compare that to the market
% median. 

score_mat = fts2mat(score_pb_ts);
pb_mat = fts2mat(pb_ts); 
pb_selected = pb_mat;
pb_selected(score_mat<0.2)=nan; 

plot(pb_ts.dates,nanmedian(pb_mat,2)); 
hold on; 
plot(pb_ts.dates,nanmedian(pb_selected,2)); 
hold off; 
datetick('x'); 
snapnow; 

%% Percentile analysis 
% let's take a look at the relationship with N

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topm',0.1*i); 
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

%%
% let's take a look at each percentile 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmn',0.1*i,0.1*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

%%
% zoom in
i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmn',0.01*i,0.01*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

%%
% signal strength

plot(sharpe_top);
hold on; 
plot(sharpe_top_percentile);
plot(sharpe_top_percentile_zoom); 
hold off; 

%% Update the result with risk adjustment 
%

%%
% let's generate the benchmark first

portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'equalweight'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_eq_weight_ts); 
benchmark = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts = fints(px.dates, benchmark,'EqualWeightIndex'); 


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmlongonly',0.1); 

portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),true);

plot(log(benchmark_ts)); 
legend('off'); 
hold on; 

plot(log(portfolio_cap_ts)); 
legend('off'); 

snapnow; 

%%
% sharpe & vol 
[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(benchmark_ts)),0)]
[sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts))) sqrt(12)*std(fts2mat(tick2ret(benchmark_ts)))]

%%
% let's take a look at the risk adjusted v.s. the capital hedged. 

portfolio_cap_factor_1_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);
portfolio_cap_factor_2_ts = fun_sequential_backtest_partial(100, px(50:end), benchmark_ts(50:end),1, portfolio_weight_ts(50:end),false);

plot(log(portfolio_cap_factor_1_ts)); 
legend('off'); 

plot(log(portfolio_cap_factor_2_ts)); 
legend('off'); 

snapnow;
hold off; 
%%
% sharpe & correlation 

[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),0)]

corrcoef(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),fts2mat(tick2ret(benchmark_ts(50:end))))
corrcoef(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),fts2mat(tick2ret(benchmark_ts(50:end))))

%%
% so there is in fact no signal in top 0.1 ... on risk adjusted basis. 

%%
% let's run the percentile analysis. 

%%
% top N


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmlongonly',0.1*i); 
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(50:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile)
snapnow; 


plot(correlation)
snapnow; 

%%
% it now looks very different from the unadjusted result. 

%%
% breakdown into percentile. 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmnlongonly',0.1*i,0.1*(i-1)); 
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(50:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile)
snapnow; 


plot(correlation)
snapnow; 

%%
% so if there is no positive drift on risk adjusted basis, then what's the
% point to include HML in the portfolio? as diversifier and a timing
% signal?
%%
%
%% Large dataset test

%%
% load the big dataset 
load('../Big Data/data_equity_list.mat'); 
load('../Big Data/data_historical_data_jan16.mat'); 

equity_list = equity_list(1:size(storage0,1),:); 

equity_list_us_large = equity_list(strcmp(equity_list(:,2),'US'),:); 
history_us_large = storage0(strcmp(equity_list(:,2),'US'),:); 

clear storage0; 
clear equity_list; 

equity_list_us_large = equity_list_us_large(not(cellfun(@isempty,history_us_large(:,1))),:); 
history_us_large = history_us_large(not(cellfun(@isempty,history_us_large(:,1))),:); 


%%
% take data sample, load data & the list
index_large = datasample(1:8900,8001,'Replace',false); 
px_large = fun_load_price_large(history_us_large, equity_list_us_large, index_large);
px_large = fun_clean_data(px_large); 
list_large = equity_list_us_large(index_large,:); 



%%
% load the PB ratios

pb_ts_large = fun_load_observations_large(history_us_large, equity_list_us_large, index_large,'pb'); 

%%
% calculate score

score_pb_ts_large = -fun_calculate_score(pb_ts_large,list_large,'sectorsort',px_large); 

%%
% compare the result:
%%
% pure long short

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'longshort'); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')
hold on; 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'longshort'); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')

hold off; 

%%
% pure top 10%


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topm',0.1); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')
hold on; 

sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)


portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmn',0.1,0.02); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')

sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topm',0.1); 
portfolio_rt_ts = fun_portfolio_return(px, portfolio_weight_ts); 

plot(cumsum(portfolio_rt_ts)); 
legend('off')

hold off; 

sqrt(12)*sharpe(fts2mat(portfolio_rt_ts),0)


%%
% each percentile 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmn',0.1*i,0.1*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile_large(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_top_percentile_large); 
snapnow; 

%%
% zoom into first 800

i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmn',0.01*i,0.01*(i-1)); 
  portfolio_topm_rt_ts = fun_portfolio_return(px_large, portfolio_weight_ts); 

  portplot = plot(fts2mat(cumsum(portfolio_topm_rt_ts)));
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_top_percentile_large_zoom(i) = sqrt(12)*sharpe(fts2mat(portfolio_topm_rt_ts),0); 
  
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_top_percentile_large_zoom); 
snapnow; 

%%
% >>>>similar to MOM, larger dataset doesn't really improve the factor<<<<<
% This is wrong due to a mistake in generating scores.. larger dataset
% helps!! 


%% Update large dataset result with risk adjustment
% 


%%
% let's generate the benchmark first

portfolio_weight_eq_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'equalweight'); 
portfolio_rt_ts = fun_portfolio_return(px_large, portfolio_weight_eq_weight_ts); 
benchmark_large = [100; 100*exp(fts2mat(cumsum(portfolio_rt_ts)))];
benchmark_ts_large = fints(px_large.dates, benchmark_large,'EqualWeightIndex'); 

%%
% let's compare the two benchmark. 

plot(log(benchmark_ts)); 
legend('off'); 
hold on; 
plot(log(benchmark_ts_large)); 
legend('off'); 
hold off; 
snapnow; 

portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmlongonly',0.1); 

portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px_large(50:end), benchmark_ts_large(50:end), portfolio_weight_ts(50:end),true);

plot(log(benchmark_ts_large)); 
legend('off'); 
hold on; 

plot(log(portfolio_cap_ts)); 
legend('off'); 

snapnow; 

%%
% sharpe & vol 
[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(benchmark_ts)),0)]
[sqrt(12)*std(fts2mat(tick2ret(portfolio_cap_ts))) sqrt(12)*std(fts2mat(tick2ret(benchmark_ts)))]

%%
% let's take a look at the risk adjusted v.s. the capital hedged. 

portfolio_cap_factor_1_ts = fun_sequential_backtest_autoadjust(100, px_large(50:end), benchmark_ts_large(50:end), portfolio_weight_ts(50:end),false);
portfolio_cap_factor_2_ts = fun_sequential_backtest_partial(100, px_large(50:end), benchmark_ts_large(50:end),1, portfolio_weight_ts(50:end),false);

plot(log(portfolio_cap_factor_1_ts)); 
legend('off'); 

plot(log(portfolio_cap_factor_2_ts)); 
legend('off'); 

snapnow;
hold off; 


%%
% sharpe & correlation 

[sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),0) sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),0)]

corrcoef(fts2mat(tick2ret(portfolio_cap_factor_1_ts)),fts2mat(tick2ret(benchmark_ts_large(50:end))))
corrcoef(fts2mat(tick2ret(portfolio_cap_factor_2_ts)),fts2mat(tick2ret(benchmark_ts_large(50:end))))

%%
% large pool seems matters, we have some positive drift here.. 

%%
% let's run the percentile analysis. 

%%
% top N


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts_large,'topmlongonly',0.1*i); 
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px_large(50:end), benchmark_ts_large(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts_large(50:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile)
snapnow; 


plot(correlation)
snapnow; 

%%
% it now looks very different from the unadjusted result. 

%%
% breakdown into percentile. 


i=1; 
while i<=10

  portfolio_weight_ts = fun_portfolio_weight_sector_neutral(score_pb_ts,'topmnlongonly',0.1*i,0.1*(i-1)); 
  portfolio_cap_ts = fun_sequential_backtest_autoadjust(100, px(50:end), benchmark_ts(50:end), portfolio_weight_ts(50:end),false);

  portplot = plot(log(portfolio_cap_ts)); 
  portplot.Color(4) = 1 - 0.1*i; 
  hold on; 
  
  sharpe_percentile(i) = sqrt(12)*sharpe(fts2mat(tick2ret(portfolio_cap_ts)),0); 
  corr = corrcoef(fts2mat(tick2ret(portfolio_cap_ts)), fts2mat(tick2ret(benchmark_ts(50:end)))); 
  correlation(i) = corr(1,2); 
  i = i+1; 

end 

hold off; 
snapnow; 

plot(sharpe_percentile)
snapnow; 


plot(correlation)
snapnow; 

%%
% so if there is no positive drift on risk adjusted basis, then what's the
% point to include HML in the portfolio? as diversifier and a timing
% signal?

##### SOURCE END #####
--></body></html>
  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">nion</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>nion</li>
          <li><a href="mailto:iam@here.now">iam@here.now</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/yuanhangw">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">yuanhangw</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/large">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">large</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">keep it simple :: finish it off :: iterate
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
